import{r as c,j as t,a6 as Me,a5 as Se,M as v,i as O,a as oe,b as Ee,k as Re,L as Ne}from"./b8ijctzpgh0s7wpx.js";import{C as le}from"./nfkxdwnvdjy1s4sn.js";import{nG as De,aO as Pe,$ as Fe,dL as ue,oO as J,oP as Y,d as $e,eb as Ae,bb as Be,dq as Ve,aX as I,oQ as Oe,oR as Ze,gv as We,gw as qe,mQ as Qe,cD as He,gy as Ue}from"./krbmwir12ubt4od1.js";import{W as H,g as ze,e as $,f as Le,C as Ge}from"./omp8ie1vzl40ti1z.js";import{F as Ke,c as Z,hc as V,aD as Xe,bi as Je,bT as Ye,cX as Ie,ad as et,bS as tt,j as st,b1 as nt,bg as Q,dp as ee}from"./citrwydz0bgriwlc.js";import{u as te}from"./cwi4lsxreiklxbjv.js";const U=Ke.div`animate-pulse rounded-[4px] bg-token-main-surface-tertiary`;function at(){return t.jsx(Me,{children:t.jsx(Se.div,{className:"border-token-border-light overflow-y-clip border-b",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},children:t.jsxs("div",{className:"flex w-full flex-col gap-0.5 px-2 py-3",children:[t.jsx(U,{className:"mt-[0.425rem] mb-[0.225rem] h-[0.6rem] w-[200px]"}),t.jsx(U,{className:"mt-[0.225rem] mb-[0.425rem] h-[0.6rem] w-[100px]"})]})})})}const rt=c.memo(at);function it({className:e,linesAdded:s,linesRemoved:i}){return!s&&!i?null:t.jsxs("div",{className:Z("flex flex-row gap-1 font-medium",e),children:[t.jsx("span",{className:"text-green-500",children:t.jsx(v,{id:"wham.message.modal.repoAndDiffStats.linesAdded",defaultMessage:"+{linesAdded}",values:{linesAdded:s}})}),t.jsx("span",{className:"text-red-500",children:t.jsx(v,{id:"wham.message.modal.repoAndDiffStats.linesRemoved",defaultMessage:"-{linesRemoved}",values:{linesRemoved:i}})})]})}function ot({dateString:e}){const s=O(),[i,o]=c.useState(()=>new Date);De(()=>o(new Date),6e4);const r=c.useMemo(()=>new Date(e),[e]),a=c.useMemo(()=>Pe(i,r),[i,r]),l=c.useMemo(()=>Fe(i,r),[i,r]);return l<1?s.formatMessage({id:"wham.formattedRelativeDateTime.justNow",defaultMessage:"Just now"}):l<60?s.formatMessage({id:"wham.formattedRelativeDateTime.minAgo",defaultMessage:"{numMinsDiff} min ago"},{numMinsDiff:l}):a===0?r.toLocaleTimeString(s.locale,{hour:"numeric",minute:"2-digit"}):r.toLocaleDateString(s.locale,{month:"short",day:"numeric"})}const lt=e=>c.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},c.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M5.4375 5.99609C5.4375 5.40929 5.9132 4.93359 6.5 4.93359C7.0868 4.93359 7.5625 5.40929 7.5625 5.99609C7.5625 6.5829 7.0868 7.05859 6.5 7.05859C5.9132 7.05859 5.4375 6.5829 5.4375 5.99609ZM6.5 3.05859C4.87766 3.05859 3.5625 4.37376 3.5625 5.99609C3.5625 7.29062 4.39988 8.38957 5.56252 8.78082V15.2114C4.39988 15.6026 3.5625 16.7016 3.5625 17.9961C3.5625 19.6184 4.87766 20.9336 6.5 20.9336C8.12234 20.9336 9.4375 19.6184 9.4375 17.9961C9.4375 16.7016 8.60014 15.6026 7.43752 15.2114V8.78081C8.60014 8.38955 9.4375 7.29061 9.4375 5.99609C9.4375 4.37376 8.12234 3.05859 6.5 3.05859ZM5.4375 17.9961C5.4375 17.4093 5.9132 16.9336 6.5 16.9336C7.0868 16.9336 7.5625 17.4093 7.5625 17.9961C7.5625 18.5829 7.0868 19.0586 6.5 19.0586C5.9132 19.0586 5.4375 18.5829 5.4375 17.9961ZM17.5 16.9414C17.5299 16.9414 17.5596 16.94 17.5888 16.9373C18.1341 16.9824 18.5625 17.4392 18.5625 17.9961C18.5625 18.5829 18.0868 19.0586 17.5 19.0586C16.9132 19.0586 16.4375 18.5829 16.4375 17.9961C16.4375 17.4392 16.866 16.9824 17.4112 16.9373C17.4404 16.94 17.47 16.9414 17.5 16.9414ZM18.4375 11.0039V15.2114C19.6001 15.6026 20.4375 16.7016 20.4375 17.9961C20.4375 19.6184 19.1224 20.9336 17.5 20.9336C15.8777 20.9336 14.5625 19.6184 14.5625 17.9961C14.5625 16.7016 15.3999 15.6026 16.5625 15.2114V11.0039C16.5625 10.4861 16.9822 10.0664 17.5 10.0664C18.0178 10.0664 18.4375 10.4861 18.4375 11.0039ZM16.4129 3.59099C16.0468 3.22488 15.4532 3.22488 15.0871 3.59099C14.721 3.95711 14.721 4.5507 15.0871 4.91682L16.1742 6.00391L15.0871 7.09099C14.721 7.45711 14.721 8.0507 15.0871 8.41682C15.4532 8.78294 16.0468 8.78294 16.4129 8.41682L17.5 7.32973L18.5871 8.41682C18.9532 8.78294 19.5468 8.78294 19.9129 8.41682C20.279 8.0507 20.279 7.45711 19.9129 7.09099L18.8258 6.00391L19.9129 4.91682C20.279 4.5507 20.279 3.95711 19.9129 3.59099C19.5468 3.22488 18.9532 3.22488 18.5871 3.59099L17.5 4.67808L16.4129 3.59099Z",fill:"currentColor"})),ut=e=>c.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},c.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M5.4375 5.99609C5.4375 5.40929 5.9132 4.93359 6.5 4.93359C7.0868 4.93359 7.5625 5.40929 7.5625 5.99609C7.5625 6.5829 7.0868 7.05859 6.5 7.05859C5.9132 7.05859 5.4375 6.5829 5.4375 5.99609ZM6.5 3.05859C4.87766 3.05859 3.5625 4.37376 3.5625 5.99609C3.5625 7.29062 4.39988 8.38957 5.56252 8.78082V15.2114C4.39988 15.6026 3.5625 16.7016 3.5625 17.9961C3.5625 19.6184 4.87766 20.9336 6.5 20.9336C8.12234 20.9336 9.4375 19.6184 9.4375 17.9961C9.4375 16.7016 8.60014 15.6026 7.43752 15.2114V8.78081C8.60014 8.38955 9.4375 7.29061 9.4375 5.99609C9.4375 4.37376 8.12234 3.05859 6.5 3.05859ZM5.4375 17.9961C5.4375 17.4093 5.9132 16.9336 6.5 16.9336C7.0868 16.9336 7.5625 17.4093 7.5625 17.9961C7.5625 18.5829 7.0868 19.0586 6.5 19.0586C5.9132 19.0586 5.4375 18.5829 5.4375 17.9961ZM17.5 16.9336C16.9132 16.9336 16.4375 17.4093 16.4375 17.9961C16.4375 18.5829 16.9132 19.0586 17.5 19.0586C18.0868 19.0586 18.5625 18.5829 18.5625 17.9961C18.5625 17.4093 18.0868 16.9336 17.5 16.9336ZM14.5625 17.9961C14.5625 16.3738 15.8777 15.0586 17.5 15.0586C19.1224 15.0586 20.4375 16.3738 20.4375 17.9961C20.4375 19.6184 19.1224 20.9336 17.5 20.9336C15.8777 20.9336 14.5625 19.6184 14.5625 17.9961ZM19 6C19 6.82843 18.3284 7.5 17.5 7.5C16.6716 7.5 16 6.82843 16 6C16 5.17157 16.6716 4.5 17.5 4.5C18.3284 4.5 19 5.17157 19 6ZM17.5 12.75C18.3284 12.75 19 12.0784 19 11.25C19 10.4216 18.3284 9.75 17.5 9.75C16.6716 9.75 16 10.4216 16 11.25C16 12.0784 16.6716 12.75 17.5 12.75Z",fill:"currentColor"})),ct=e=>c.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},c.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M6 5C5.44772 5 5 5.44772 5 6C5 6.55228 5.44772 7 6 7C6.55228 7 7 6.55228 7 6C7 5.44772 6.55228 5 6 5ZM3 6C3 4.34315 4.34315 3 6 3C7.30622 3 8.41746 3.83481 8.82929 5H15C17.2091 5 19 6.79086 19 9V15.1707C20.1652 15.5825 21 16.6938 21 18C21 19.6569 19.6569 21 18 21C16.3431 21 15 19.6569 15 18C15 16.6938 15.8348 15.5825 17 15.1707V9C17 7.89543 16.1046 7 15 7H8.82929C8.52801 7.85241 7.85241 8.52801 7 8.82929V15.1707C8.16519 15.5825 9 16.6938 9 18C9 19.6569 7.65685 21 6 21C4.34315 21 3 19.6569 3 18C3 16.6938 3.83481 15.5825 5 15.1707V8.82929C3.83481 8.41746 3 7.30622 3 6ZM6 17C5.44772 17 5 17.4477 5 18C5 18.5523 5.44772 19 6 19C6.55228 19 7 18.5523 7 18C7 17.4477 6.55228 17 6 17ZM17 18C17 17.4477 17.4477 17 18 17C18.5523 17 19 17.4477 19 18C19 18.5523 18.5523 19 18 19C17.4477 19 17 18.5523 17 18Z",fill:"currentColor"})),dt=e=>c.createElement("svg",{width:24,height:24,viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},c.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M4.93762 5.99609C4.93762 5.40929 5.41332 4.93359 6.00012 4.93359C6.58692 4.93359 7.06262 5.40929 7.06262 5.99609C7.06262 6.5829 6.58692 7.05859 6.00012 7.05859C5.41332 7.05859 4.93762 6.5829 4.93762 5.99609ZM6.00012 3.05859C4.37779 3.05859 3.06262 4.37376 3.06262 5.99609C3.06262 7.29057 3.89993 8.38948 5.0625 8.78078V15.2114C3.89993 15.6027 3.06262 16.7016 3.06262 17.9961C3.06262 19.6184 4.37779 20.9336 6.00012 20.9336C7.62246 20.9336 8.93762 19.6184 8.93762 17.9961C8.93762 16.7015 8.10019 15.6025 6.9375 15.2113V8.78086C8.10019 8.38964 8.93762 7.29066 8.93762 5.99609C8.93762 4.37376 7.62246 3.05859 6.00012 3.05859ZM4.93762 17.9961C4.93762 17.4093 5.41332 16.9336 6.00012 16.9336C6.58692 16.9336 7.06262 17.4093 7.06262 17.9961C7.06262 18.5829 6.58692 19.0586 6.00012 19.0586C5.41332 19.0586 4.93762 18.5829 4.93762 17.9961ZM14.6629 4.65901L14.2594 5.0625H16.0001C17.6225 5.0625 18.9376 6.37766 18.9376 8V11C18.9376 11.5178 18.5179 11.9375 18.0001 11.9375C17.4824 11.9375 17.0626 11.5178 17.0626 11V8C17.0626 7.4132 16.5869 6.9375 16.0001 6.9375H14.2672L14.6629 7.33318C15.029 7.6993 15.029 8.29289 14.6629 8.65901C14.2968 9.02512 13.7032 9.02512 13.3371 8.65901L11.3371 6.65901C10.971 6.29289 10.971 5.6993 11.3371 5.33318L13.3371 3.33318C13.7032 2.96706 14.2968 2.96706 14.6629 3.33318C15.029 3.6993 15.029 4.29289 14.6629 4.65901ZM18.9374 15.2461C18.9374 14.7283 18.5176 14.3086 17.9999 14.3086C17.4821 14.3086 17.0624 14.7283 17.0624 15.2461V16.8086H15.4999C14.9821 16.8086 14.5624 17.2283 14.5624 17.7461C14.5624 18.2639 14.9821 18.6836 15.4999 18.6836H17.0624V20.2461C17.0624 20.7639 17.4821 21.1836 17.9999 21.1836C18.5176 21.1836 18.9374 20.7639 18.9374 20.2461V18.6836H20.4999C21.0176 18.6836 21.4374 18.2639 21.4374 17.7461C21.4374 17.2283 21.0176 16.8086 20.4999 16.8086H18.9374V15.2461Z",fill:"currentColor"}));function mt(e){return e?e.merged?"merged":e.state==="closed"?"closed":e.draft?"draft":"open":null}function ft({taskAssistantTurnId:e,taskId:s,data:i,className:o}){const[r,a]=c.useState(i),l=c.useRef(!1);if(c.useEffect(()=>{async function m(){if(!(!r||!e||!s||l.current)){if(!r.merged)try{const u=await H.getTaskTurnPR(s,e);a(u.pr)}catch{}l.current=!0}}m()},[r,e,s]),!r)return null;const n=mt(r);if(!n)return null;const d=r.url,p=m=>{m.stopPropagation(),m.preventDefault(),window.open(d,"_blank","noopener,noreferrer")};return t.jsx("button",{type:"button",onClick:p,onAuxClick:m=>{m.button===1&&p(m)},className:Z("inline-flex w-fit cursor-pointer items-center rounded-full px-2.5 py-1 text-[10px] font-semibold","hover:border-token-border-heavy border border-transparent hover:border hover:opacity-80",{"bg-[#C3DEC780] text-[#008C2E] dark:bg-[#6BBD6720] dark:text-[#6BBD67]":n==="open","bg-[#D6303D20] text-[#D6303D] dark:bg-[#FD756F20] dark:text-[#FD756F]":n==="closed","bg-[#8E3CF320] text-[#8E3CF3] dark:bg-[#C26FFD20] dark:text-[#C26FFD]":n==="merged","bg-[#59636E20] text-[#59636E] dark:bg-[#B2B2B220] dark:text-[#B2B2B2]":n==="draft"},o),children:n==="open"?t.jsxs(t.Fragment,{children:[t.jsx(dt,{"aria-hidden":!0,className:"icon-xs me-1"}),t.jsx(v,{id:"wham.prStatusBadge.open",defaultMessage:"Open"})]}):n==="closed"?t.jsxs(t.Fragment,{children:[t.jsx(lt,{"aria-hidden":!0,className:"icon-xs me-1"}),t.jsx(v,{id:"wham.prStatusBadge.closed",defaultMessage:"Closed"})]}):n==="merged"?t.jsxs(t.Fragment,{children:[t.jsx(ct,{"aria-hidden":!0,className:"icon-xs me-1"}),t.jsx(v,{id:"wham.prStatusBadge.merged",defaultMessage:"Merged"})]}):t.jsxs(t.Fragment,{children:[t.jsx(ut,{"aria-hidden":!0,className:"icon-xs me-1"}),t.jsx(v,{id:"wham.prStatusBadge.draft",defaultMessage:"Draft"})]})})}function Ft(e){return e?.output_items?.map(s=>s.type==="output_diff"?s.diff:s.type==="pr"?s.output_diff.diff:null)?.filter(s=>!!s)??[]}function pt(e){if(e==null)return"";const s=e?.environment?.repos?.[0],i=s?e?.environment?.repo_map?.[s]:null,o=i&&gt(i)?ht(i.git_url):null,r=e?.branch;return e.output_items.filter(a=>a.type==="message").flatMap(a=>a.content).map(a=>{const l=a.content_type;switch(l){case"text":return a.text;case"terminal_chunk_citation":return`${V}:${Y}[${Y}]{line_range_start=${a.line_range_start} line_range_end=${a.line_range_end} terminal_chunk_id=${a.terminal_chunk_id}}${V}`;case"repo_file_citation":{const n=o?`${o}/blob/${r}/${a.path}#L${a.line_range_start}-L${a.line_range_end}`:null;return`${V}:${J}[${J}]{line_range_start=${a.line_range_start} line_range_end=${a.line_range_end} path=${a.path}${n?` git_url="${n}"`:""}}${V}`}case void 0:return"";default:ue(l)}return""}).join("")}function ht(e){return e.replace(/\.git$/,"").replace("git://","https://")}function gt(e){return e?.id?.startsWith("github")||(e?.git_url?.indexOf("github.com")??-1)>=0}function Ct(e){return"output_items"in e}function $t(e){return"input_items"in e}function xt(e){return e?e.input_items?.flatMap(s=>"content"in s?s?.content:[])?.map(s=>s.content_type==="text"?s.text:"")?.join("")??"":""}function At(e){return e?Ct(e)?pt(e):xt(e):""}function Bt(e){return e?.turn!=null}function se(e){return G(e.task_status_display?.latest_turn_status_display?.turn_status)}function G(e){switch(e){case null:case void 0:case"completed":case"failed":case"cancelled":return!0;case"pending":case"in_progress":return!1;default:ue(e)}}function _t(e,s,i){const o=O(),[r,a]=c.useState(i?o.formatMessage({id:"wham.useStreamTurn.preparingTask",defaultMessage:"Working on your task"}):""),[l,n]=c.useState(r);c.useEffect(()=>{const p=$e(()=>n(r),200);return p(),p.cancel},[r]);const d=c.useMemo(()=>`last-event-${e}-${i??""}-${Math.random().toString(36).slice(2)}`,[e,i]);return ce(e,i,["task_turn_event"],{enabled:!!i&&!G(s),subscriberId:d,onEvent:p=>a(p.task_turn_event.text)}),l}function ce(e,s,i,{enabled:o=!0,subscriberId:r,onEvent:a,onComplete:l}){const n=te(a),d=te(l),p=Ae(i),m=oe(),u=c.useCallback(C=>{n.current(C)},[n]),f=c.useCallback(()=>{d.current?.()},[d]);c.useEffect(()=>{if(!(!s||!o))return re.retainTurnStream(m,e,s,r,p,u,f),()=>{re.releaseTurnStream(e,s,r)}},[e,s,r,p,o,m,u,f])}async function*bt({taskId:e,turnId:s,abortSignal:i,types:o}){let a=window.location.origin+`/backend-api/wham/tasks/${e}/turns/${s}/stream`;if(o.length>0){const n=o.map(d=>`item_type=${encodeURIComponent(d)}`).join("&");a+=`?${n}`}const l=Be(a,{method:"GET",signal:i,headers:{...Ye({isAuthOptional:!1}),"Content-Type":"text/event-stream"},observer:{onClose:(n,d)=>{if(d&&!z(d))throw d}}});try{for await(const n of l){const d=vt(n);d&&(!o||o.includes(d.item_type)?yield d:Ie.warn("Unknown event type",{event:n}))}}catch(n){if(z(n))return;throw n}}function vt(e){return!("data"in e)||!e.data||e.event==="heartbeat"?null:e.data}function z(e){return!!e&&typeof e=="object"&&e.name==="AbortError"}const de=Xe(Je(()=>({turnStreams:{}}))),L=de.getState,F=de.setState;function ne(e,s){return`${e}:${s}`}const ae=20;function wt(e,s,i,o){let r;return F(a=>{const l=a.turnStreams[s];if(!l)return;if(l.initPromise){r=l.initPromise;return}const{abortController:n}=l,p=(async()=>{let m=0;const u=f=>{const C=[];F(j=>{const _=j.turnStreams[s];_&&(_.seenEventIds.has(f.id)||(_.seenEventIds.add(f.id),_.emittedEvents.push(f),Object.values(_.subscribers).forEach(h=>{if(!h.types.includes(f.item_type))return;const x=h.lastTimestamps[f.item_type];x&&f.timestamp<=x||(h.lastTimestamps[f.item_type]=f.timestamp,C.push(h.onEvent))})))}),C.forEach(j=>j(f))};for(;!n.signal.aborted&&m<ae;){try{const h=bt({taskId:i,turnId:o,abortSignal:n.signal,types:["task_turn_event","work_log_message","log","task_title_generated"]});for await(const x of h){if(n.signal.aborted)break;u(x)}}catch(h){if(z(h)||n.signal.aborted)break}const f=ze(i,o,e),C=await e.fetchQuery(f),j=G(C.turn.turn_status);if(j&&e.refetchQueries({queryKey:["wham","task",i]}),m+=1,m>=ae||n.signal.aborted||j)break;const _=Math.min(16e3,1e3*2**m)+Math.random()*500;await new Promise(h=>setTimeout(h,_))}if(!n.signal.aborted){const f=L().turnStreams[s]?.subscribers;Object.values(f??{}).forEach(C=>{C.onComplete?.()})}})().finally(()=>{F(m=>{const u=m.turnStreams[s];u&&u.initPromise===p&&(u.initPromise=null,Object.keys(u.subscribers).length||delete m.turnStreams[s])})});l.initPromise=p,r=p}),r??L().turnStreams[s]?.initPromise??Promise.resolve()}const re={async retainTurnStream(e,s,i,o,r,a,l){const n=ne(s,i);let d=!1;F(m=>{let u=m.turnStreams[n];u?u.initPromise||(d=!0,u.abortController=new AbortController):(d=!0,u={subscribers:{},abortController:new AbortController,initPromise:null,emittedEvents:[],seenEventIds:new Set},m.turnStreams[n]=u);const f=u.subscribers[o];f?(f.types=Array.from(r),f.onEvent=a,f.onComplete=l):u.subscribers[o]={subscriberId:o,types:Array.from(r),onEvent:a,onComplete:l,lastTimestamps:{}}});const p=L().turnStreams[n].emittedEvents;for(const m of p)r.includes(m.item_type)&&a(m);d&&await wt(e,n,s,i)},releaseTurnStream(e,s,i){const o=ne(e,s);let r=!1,a;F(l=>{const n=l.turnStreams[o];!n||!n.subscribers[i]||(delete n.subscribers[i],Object.keys(n.subscribers).length||(r=!0,a=n.abortController,delete l.turnStreams[o]))}),r&&a&&a.abort()}};function yt(e,s){return!e||e.length<=s?e:e.slice(0,s/2)+"…"+e.slice(-s/2)}function ie(e){return e==="archived"?{add:["current","all"],remove:["archived"]}:{add:["archived"],remove:["current","all"]}}function kt({taskListItem:e,index:s,disableFocusStyle:i,hoveredIndex:o,isCompact:r=!1,hideBorder:a=!1,onMouseEnter:l,onMouseLeave:n}){const d=O(),p=et(),m=Ve(),u=$(g=>g.tasksFilter),f=$(g=>g.removePendingTaskByTaskId),C=e.task_status_display?.latest_turn_status_display?.turn_status??"pending",j=_t(e.id,C,e.task_status_display?.latest_turn_status_display?.turn_id),_=e.task_status_display?.latest_turn_status_display?.diff_stats?.lines_added??0,h=e.task_status_display?.latest_turn_status_display?.diff_stats?.lines_removed??0,x=tt(e.pull_requests)?.pull_request,me=!0,fe=x?.head,pe=e.task_status_display?.branch_name,w=fe??pe,K=(w?.length??0)>48?"…"+w?.slice(-48):w,he=w&&w.length!==K?.length,ge=!m&&w&&w!=="master"&&w!=="main"&&x?.state!=="closed"&&x?.state!=="merged",Ce=c.useMemo(()=>t.jsx(le,{size:20,initialOffset:Math.random()*20*Math.PI}),[]),b=oe(),xe=s!==void 0&&o!=null&&s===o-1,_e=st(),be=nt(_e,"2665240312")||void 0;c.useEffect(()=>{f(e.id)},[e.id,f]);const{mutate:ve}=Ee({mutationFn:({taskId:g,currentFilter:M})=>M==="archived"?H.recoverTask(g):H.archiveTask(g),onMutate:async({taskId:g,taskListItem:M,currentFilter:S})=>{const{add:E,remove:R}=ie(S),N={},A=async y=>{N[y.join("|")]=b.getQueryData(y),await b.cancelQueries({queryKey:y})};for(const y of R){const k=["wham","tasks",y];await A(k),b.setQueryData(k,W=>Q(W,D=>{D?.pages.forEach(P=>{P.items=(P.items??[]).filter(q=>q.id!==g)})}))}for(const y of E){const k=["wham","tasks",y];await A(k),b.setQueryData(k,W=>Q(W,D=>{if(!D||D.pages.length===0)return;const P=D.pages[0],q=P.items??[];P.items=[M,...q].filter((ye,ke,je)=>je.findIndex(Te=>Te.id===ye.id)===ke)}))}const B=["wham","task",M.id,M.task_status_display?.latest_turn_status_display?.turn_id];return N[B.join("|")]=b.getQueryData(B),await b.cancelQueries({queryKey:B}),b.setQueryData(B,y=>Q(y,k=>{k&&(k.task.archived=!k.task.archived)})),{snapshots:N}},onError:(g,M,S)=>{Object.entries(S?.snapshots??{}).forEach(([E,R])=>{b.setQueryData(E.split("|"),R)}),p.danger(d.formatMessage({id:"wham.whamTaskRow.failedToUpdateTask",defaultMessage:"Failed to update task"}))},onSuccess:(g,M)=>{const{taskListItem:S,currentFilter:E}=M,{add:R,remove:N}=ie(E);b.invalidateQueries({queryKey:["wham","task",S.id,S.task_status_display?.latest_turn_status_display?.turn_id]}),[...R,...N].forEach(A=>b.invalidateQueries({queryKey:["wham","tasks",A]}))}}),T=[];switch(C){case"pending":case"in_progress":{r?T.push(Ce):T.push(t.jsx("span",{className:"loading-shimmer-pure-text",children:yt(j,32)},"in-progress-text"));break}case"failed":T.push(t.jsx("span",{className:"text-token-text-error",children:t.jsx(v,{id:"wham.whamTaskRow.failed",defaultMessage:"Failed"})},"failed-text"));break;case"cancelled":T.push(t.jsx("span",{className:"text-token-text-secondary",children:t.jsx(v,{id:"wham.whamTaskRow.cancelled",defaultMessage:"Cancelled"})},"cancelled-text"));break;case"completed":{x&&me&&T.push(t.jsx(ft,{taskAssistantTurnId:e.task_status_display?.latest_turn_status_display?.turn_id,taskId:e.id,data:x},"pr-status")),(_!==0||h!==0)&&T.push(t.jsx(it,{className:"min-w-15 justify-end",linesAdded:_,linesRemoved:h},"message-stats"));break}default:T.push(t.jsx("span",{className:"text-token-text-secondary",children:t.jsx(v,{id:"wham.whamTaskRow.unknown",defaultMessage:"Unknown"})},"unknown-text"));break}const X=e.updated_at?new Date(e.updated_at*1e3):null,we=e.task_status_display?.environment_label;return t.jsx("div",{className:"group task-row-container",onMouseEnter:l,onMouseLeave:n,children:t.jsxs(jt,{disableFocusStyle:i,taskId:e.id,children:[t.jsxs("div",{className:Z("border-token-border-light grid w-full grid-cols-[minmax(0,1fr)_auto] items-center gap-5 border-b px-4 py-3 text-sm hover:border-b-transparent md:px-2",(xe||a)&&"border-b-transparent"),children:[t.jsxs("div",{className:"flex flex-col gap-0.5",children:[t.jsxs("div",{className:"text-token-text-primary flex w-full min-w-0 items-center gap-1.5",children:[e.has_unread_turn&&t.jsx("div",{className:"size-1.5 rounded-full bg-blue-500"}),t.jsx("div",{className:"flex-1 truncate font-medium",children:t.jsx(Tt,{task:e})})]}),X&&t.jsxs("div",{className:"text-token-text-tertiary flex gap-1",children:[t.jsx("span",{className:"truncate empty:hidden",children:t.jsx(ot,{dateString:X.toISOString()})}),t.jsx("span",{className:"text-token-text-tertiary",children:"·"}),t.jsx("span",{className:"truncate empty:hidden",children:we}),ge&&t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"text-token-text-tertiary",children:"·"}),t.jsx(I,{label:he?w:void 0,children:t.jsx("span",{className:"max-w-[8rem] truncate md:max-w-[10rem]",children:K})})]})]})]}),t.jsxs("div",{className:"flex flex-1 items-center gap-2",children:[x&&!1,T]})]}),be&&!r&&t.jsx("div",{role:"button",onClick:g=>{g.stopPropagation(),g.preventDefault(),ve({taskId:e.id,taskListItem:e,currentFilter:u})},className:"before:from-token-bg-tertiary before:via-token-bg-tertiary absolute inset-y-0 end-0 z-20 flex w-14 cursor-pointer items-center justify-end rounded-e-lg pe-2 opacity-0 transition-opacity duration-0 group-hover:opacity-100 group-hover:duration-150 before:pointer-events-none before:absolute before:inset-0 before:-start-0.5 before:rounded-e-lg before:bg-gradient-to-l before:to-transparent before:content-['']",children:t.jsx(I,{label:e.archived?d.formatMessage({id:"wham.whamTaskRow.unarchiveTask",defaultMessage:"Unarchive task"}):d.formatMessage({id:"wham.whamTaskRow.archiveTask",defaultMessage:"Archive task"}),side:"top",children:e.archived?t.jsx(Oe,{className:"icon-sm text-token-text-secondary bg-token-bg-tertiary hover:text-token-text-primary relative z-10"}):t.jsx(Ze,{className:"icon-sm text-token-text-secondary bg-token-bg-tertiary hover:text-token-text-primary relative z-10"})})})]})})}function jt({taskId:e,children:s,disableFocusStyle:i}){const o=$(n=>n.setLastViewedTaskId),r=$(n=>n.lastViewedTaskId),a=c.useRef(null),l=Re();return c.useEffect(()=>{r===e&&requestAnimationFrame(()=>{a.current?.scrollIntoView({behavior:"instant",block:"center"}),l.state?.focusComposer||a.current?.focus()})},[]),e?t.jsx("div",{className:Z("hover:bg-token-bg-tertiary relative rounded-lg ring-inset",!i&&"focus-within:ring-token-border-heavy focus-within:z-10 focus-within:ring-1 focus-within:outline-black/5"),children:t.jsx(Ne,{className:"outline-offset-[-1px] focus-within:rounded-lg",ref:a,to:`/codex/tasks/${e}`,onClick:()=>o(e),onMouseDown:n=>n.preventDefault(),children:s})}):t.jsx("div",{className:"hover:bg-token-bg-tertiary relative rounded-lg",children:s})}function Tt({task:e}){const s=O(),i=e.task_status_display?.latest_turn_status_display,o=i?i.turn_status??"pending":"failed",[r,a]=c.useState(),l=i?.turn_id,n=e.has_generated_title===!1&&(o==="pending"||o==="in_progress")&&!!l,d=c.useMemo(()=>`title-${e.id}-${l??""}`,[e.id,l]);return ce(e.id,l,["task_title_generated"],{enabled:n,subscriberId:d,onEvent:p=>a(p.title)}),o==="failed"&&e.has_generated_title===!1?s.formatMessage({id:"wham.whamTaskRow.codexTask",defaultMessage:"Codex task"}):e.has_generated_title===!1&&!r?t.jsx(U,{className:"mt-[0.425rem] mb-[0.225rem] h-[0.6rem] w-[200px]"}):t.jsx("span",{children:r??e.title})}function Mt({pendingTaskIds:e,inProgressTasks:s,closePopover:i}){return!s.length&&!e.length?t.jsx("div",{className:"flex min-w-48 items-center justify-center py-5",children:t.jsx(v,{id:"FvzFV8",defaultMessage:"No pending tasks"})}):t.jsxs("ol",{className:"max-h-[600px] w-[450px] overflow-y-auto p-2",children:[e.map(o=>t.jsx(rt,{},o)),s.map((o,r)=>t.jsx("li",{onClick:i,children:t.jsx(kt,{index:r,taskListItem:o,isCompact:!0,disableFocusStyle:!0,hoveredIndex:null,onMouseEnter:ee,onMouseLeave:ee,hideBorder:r===s.length-1})},o.id))]})}function Vt(){const[e,s]=c.useState(!1),i=c.useRef(null),{data:o}=Le(),r=$(({pendingTaskIds:u})=>u),a=o?.pages.flatMap(u=>u.items??[])??[],l=a.filter(u=>!se(u)),n=a.filter(u=>!!u.has_unread_turn),d=a.filter(u=>!!u.has_unread_turn||!se(u)),p=Array.from(Object.values(r)).filter(u=>!a.some(f=>f.id===u)),m=l.length+p.length;return t.jsxs(We,{onOpenChange:s,children:[t.jsx(qe,{asChild:!0,children:t.jsx(Qe,{children:m===0?t.jsxs("div",{className:"relative",children:[n.length>0&&t.jsx("div",{className:"absolute start-0 top-0 size-1.5 rounded-full bg-blue-500"}),t.jsx(He,{})]}):t.jsx(le,{size:24,arcPercentage:e?1:.25,children:t.jsx("span",{className:"text-xs",children:m})})})}),t.jsx(Ue,{forceMount:!0,children:t.jsx(Ge,{isOpen:e,closePopover:()=>s(!1),popoverContentRef:i,align:"end",side:"bottom",sideOffset:8,alignOffset:-8,children:t.jsx(Mt,{pendingTaskIds:p,inProgressTasks:d,closePopover:()=>s(!1)})})})]})}export{Vt as N,it as W,rt as a,kt as b,z as c,Ct as d,_t as e,At as f,Ft as g,Bt as h,G as i,$t as j,yt as m,ce as u};
//# sourceMappingURL=eeyp7d7oqudhas3m.js.map
