import{aM as J,aI as Se,aF as ve,al as Qe,aZ as ft,aH as ce,j as Ve,b1 as pt,eJ as ht,cc as yt,m as _t,e as Me,s as x,N as A,a_ as Q,n as H,bY as St,aS as vt,dQ as wt,a$ as ge,h as ie,cg as Tt,hf as Ct,c8 as bt,bj as ke,aJ as Et,cw as Re,b as Mt,d as kt,ak as Rt,ah as xt,k as At,eB as Ye,hg as Ht,hh as Pt,hi as It,bl as Fe,cp as qt,bm as Dt,ce as Ft,hj as Ot,gP as Lt,ei as Oe,fT as Le,dR as Nt,aT as Kt,ch as Ut,hk as jt,bL as zt,hl as $t,ad as Bt,hm as Gt,dg as Wt,di as Jt,dj as Qt,dl as Vt,dw as Yt,dx as Zt,B as Ne,O as Xt}from"./citrwydz0bgriwlc.js";import{q4 as en,b8 as tn,d as nn,q5 as sn,q6 as Ke,bb as on,bd as rn,q7 as an,bc as cn,au as Ue,lI as ln,q8 as dn,q9 as un,c5 as gn,qa as mn,iu as fn,qb as pn,qc as hn,iC as yn,qd as _n,qe as Sn,qf as je,ek as vn,qg as wn,qh as Tn,qi as Cn,aj as bn,iE as En,kc as ze,qj as Mn,qk as kn,ql as Rn,pE as xn,lG as An,px as Hn,ig as Pn,qm as $e,qn as In}from"./krbmwir12ubt4od1.js";import{c as pe,r as w,a as Ze,f as qn,i as Dn,j as S,M as ne}from"./b8ijctzpgh0s7wpx.js";import{d as V,P as Y,D as re,a as Xe,T as we,p as Fn}from"./k1h56nx2kjoqc52m.js";import{a as ae,g as On}from"./exvo283q5zxd2q6r.js";const et="prompt-textarea";function fs(){document.getElementById(et)?.focus()}const ps={getAndReset:(e,t)=>{const n=Se.getItem(ve.RestoreMessageAfterOauthRedirect);return Se.removeItem(ve.RestoreMessageAfterOauthRedirect),!n||n.userId!==e||t!==n.serverThreadId||Date.now()>n.expiresAt?null:n},set:(e,t,n)=>{const s={userId:e,serverThreadId:t,inputText:n,expiresAt:Date.now()+6e4};Se.setItem(ve.RestoreMessageAfterOauthRedirect,s)}},xe=()=>{"use forget";return ae.useState(ae.getPersistedSystemHints)},hs=()=>{"use forget";const e=pe.c(2),t=xe();let n;return e[0]!==t?(n=t.has(J.Search),e[0]=t,e[1]=n):n=e[1],n},ys=()=>{"use forget";const e=pe.c(2),t=xe();let n;return e[0]!==t?(n=t.has(J.Research),e[0]=t,e[1]=n):n=e[1],n},_s=e=>{"use forget";const t=pe.c(3),n=ae.useState(ae.getPersistedSystemHints);let s;return t[0]!==n||t[1]!==e?(s=n.has(e),t[0]=n,t[1]=e,t[2]=s):s=t[2],s},Ln=()=>{"use forget";const e=pe.c(16),t=ae.useStore();let n;e[0]!==t?(n=l=>t.getPersistedSystemHintTrigger(l),e[0]=t,e[1]=n):n=e[1];const s=n;let o;e[2]!==t?(o=l=>t.clearPersistedSystemHintTrigger(l),e[2]=t,e[3]=o):o=e[3];const i=o;let r;e[4]!==t?(r=l=>{const h=l===void 0?{}:l;return t.clearAllPersistedSystemHintTriggers(h)},e[4]=t,e[5]=r):r=e[5];const c=r;let a;e[6]!==t?(a=(l,h,m,_)=>{(h?t.addPersistedSystemHint:t.removePersistedSystemHint)(l,m,_)},e[6]=t,e[7]=a):a=e[7];const u=a;let d;e[8]!==t?(d=(l,h,m)=>{t.updatePersistedSystemHint(l,h,m)},e[8]=t,e[9]=d):d=e[9];const f=d;let g;return e[10]!==c||e[11]!==i||e[12]!==s||e[13]!==u||e[14]!==f?(g={getSystemHintModeTrigger:s,clearSystemHintModeTrigger:i,setThreadSystemHintMode:u,clearAllSystemHintModeTriggers:c,updateSystemHint:f},e[10]=c,e[11]=i,e[12]=s,e[13]=u,e[14]=f,e[15]=g):g=e[15],g},Ss=(e,t,n,s,o,i,r)=>e?"file_upload_pending":s?i&&r?void 0:"async_task_pending":t?n?"text_content_too_long":o?"no_source_selected_dr":void 0:"empty_text_content",Nn=e=>e.replace(/[\u{E0000}-\u{E007F}]+/gu,""),vs=e=>{const t=Nn(e.getContentToSend().content);return Math.ceil(t.length/4)};function ws(e,t){return e?t===void 0?!0:t.includes(e):!1}function Ts(e,t,n){const s=e?[J.Think]:[];if(n.size>0)return s.concat(Array.from(n));const o=t.getSystemHint();return o?s.concat([o]):s}const tt=new V("transactionEventPlugin"),Be="prosemirrorDispatchTransaction";function Ge(e,t){const{eventTarget:n}=tt.getState(e.state);return n.addEventListener(Be,t),()=>{n.removeEventListener(Be,t)}}function Cs(e){return new Y({key:tt,state:{init(){return{eventTarget:e}},apply(t,n){return n}}})}const ue=new V("customKeymapPlugin");function Kn(e,t){e.dispatch(e.state.tr.setMeta(ue,{handlers:t}))}function bs(e={handlers:{}}){return new Y({key:ue,state:{init(){return{...e}},apply(t,n){const s=t.getMeta(ue);return s?{...n,...s}:n}},props:{handleKeyDown(t,n){const o=ue.getState(t.state).handlers[n.key];return o?o(n):!1}}})}const Es=e=>e?{enabled:!!Qe(e,"463092697").value?.softmentionEnabled}:{enabled:!1};function Un(){return{trackingKeywordsRegex:void 0,decorations:re.empty,highlightedKeywords:new Set,matchedKeywords:new Set}}const nt=({tr:e,regex:t,prevHighlightedKeywords:n,prevMatchedKeywords:s})=>{const o=[],i=new Set,r=new Set;return t?(e.doc.descendants((c,a)=>{if(!c.isText||!c.text)return;const u=c.text;for(const d of u.matchAll(t)){if(i.add(d[1]),!n.has(d[1])&&s.has(d[1]))continue;r.add(d[1]);const f=a+d.index,g=f+d[0].length;o.push(Xe.inline(f,g,{class:"hint-pill"},{keyword:d[1]}))}}),{decorations:re.create(e.doc,o),matchedKeywords:i,highlightedKeywords:r}):{decorations:re.empty,matchedKeywords:i,highlightedKeywords:r}},jn=(e,t)=>{const{state:n,dispatch:s}=t,o=n.tr,i=q.getState(n);if(i){const r=e.length>0?new RegExp(`\\b(${e.join("|")})\\b`,"gi"):void 0,{decorations:c,highlightedKeywords:a,matchedKeywords:u}=nt({tr:o,regex:r,prevHighlightedKeywords:i.highlightedKeywords,prevMatchedKeywords:i.matchedKeywords});o.setMeta(q,{...i,trackingKeywordsRegex:r,decorations:c,highlightedKeywords:a,matchedKeywords:u})}s(o)},zn=(e,t)=>{if(e.length===0)return;const{state:n,dispatch:s}=t,o=n.tr,i=q.getState(n);if(i){const r=i.decorations.remove(i.decorations.find(void 0,void 0,c=>c.keyword&&e.includes(c.keyword)));o.setMeta(q,{...i,decorations:r,highlightedKeywords:new Set([...i.highlightedKeywords].filter(c=>!e.includes(c)))})}s(o)},q=new V("keywordPlugin");function Ms(){return new Y({key:q,state:{init(){return Un()},apply(e,t){if(e.getMeta(q))return{...t,...e.getMeta(q)};if(!e.docChanged)return t;const{decorations:n,matchedKeywords:s,highlightedKeywords:o}=nt({tr:e,regex:t.trackingKeywordsRegex,prevHighlightedKeywords:t.highlightedKeywords,prevMatchedKeywords:t.matchedKeywords});return{...t,decorations:n,highlightedKeywords:o,matchedKeywords:s}}},props:{decorations(e){const t=this.getState(e);return t?t.decorations:re.empty}}})}const N=new V("menuSelectorPlugin");function We(e){e.dispatch(e.state.tr.setMeta(N,{active:!1,onMenuAction:void 0}))}function ks(e,t){e.dispatch(e.state.tr.setMeta(N,{active:!0,onMenuAction:t}))}function Rs(e={submitKeys:["Enter","Tab"],cancelKeys:["Escape"],checkStrictMatchKeys:[" "]}){return new Y({key:N,state:{init(){return{...e,active:!1}},apply(t,n){const s=t.getMeta(N);return s?{...n,...s}:n}},props:{handleKeyDown(t,n){const s=N.getState(t.state);if(!s.active)return!1;if(!n.isComposing)return s.submitKeys.includes(n.key)?(n.preventDefault(),n.stopPropagation(),n.stopImmediatePropagation(),We(t),s.onMenuAction?.("submit")??!0):s.cancelKeys.includes(n.key)?(n.preventDefault(),s.onMenuAction?.("cancel"),We(t),!0):n.key==="ArrowUp"?(n.preventDefault(),s.onMenuAction?.("up"),!0):n.key==="ArrowDown"?(n.preventDefault(),s.onMenuAction?.("down"),!0):s.checkStrictMatchKeys.includes(n.key)&&s.onMenuAction?.("checkMatch")?(n.preventDefault(),!0):!1},handleDOMEvents:{blur:t=>{N.getState(t.state).onMenuAction?.("cancel")}}}})}const oe=new V("placeholderPlugin");function xs(e){return new Y({key:oe,state:{init(){return{placeholder:e}},apply(t,n){return t.getMeta(oe)?{placeholder:t.getMeta(oe).placeholder}:n}},props:{decorations(t){const{doc:n}=t;if(n.childCount===1&&n.firstChild?.isTextblock&&n.firstChild.content.size===0){const o=[],{placeholder:i}=oe.getState(t);return t.doc.descendants((r,c)=>{const a=Xe.node(c,c+r.nodeSize,{class:"placeholder","data-placeholder":i});o.push(a)}),re.create(n,o)}}}})}const me="command_token",As={group:"inline",inline:!0,atom:!0,content:"text*",attrs:{id:"",hint:""},selectable:!1,draggable:!1,toDOM:e=>["span",{"data-mention-id":e.attrs.id,"data-mention-hint":e.attrs.hint,class:"hint-pill"},e.attrs.hint],parseDOM:[{tag:"span[data-mention-id][data-mention-hint]",getAttrs:e=>{const t=e.getAttribute("data-mention-id"),n=e.getAttribute("data-mention-hint");return{id:t,hint:n}}}]};function st(e,t){if(e.depth===0)return;const n=e.nodeBefore?.text?.match(/(?:^|\s)(\/(\w*))$/);if(n?.[1].length!==void 0){const s=e.pos-n[1].length,o=e.pos,i=s===t?.from;return{range:{from:s,to:o},queryText:n[2],isDismissed:i}}}const Ce=new V("systemHintPlugin");function ot(e,t){return e.setMeta(Ce,t),e}function Hs(e){const n=e.state.selection.$from,s=st(n,void 0);e.dispatch(ot(e.state.tr,{...fe(),dismissedRange:s?.range}))}function fe(){return{queryText:"",active:!1,range:void 0,dismissedRange:void 0}}function $n(e,t,n,s,o){const i=e.state.tr;ot(i,fe());const r=n+" ",c=e.state.schema.nodes[me].create({id:t,hint:r},e.state.schema.text(r));if(o===s){const a=i.doc.resolve(s).nodeAfter;if(a?.isText){const u=a?.textContent.match(new RegExp(`^(?:${n}) ?`));u&&(o=s+u[0].length)}}i.replaceWith(s,o,c),i.doc.descendants((a,u)=>{a.type.name===me&&a!==c&&(s===1&&u===s+c.nodeSize||u===1&&s===u+a.nodeSize?i.delete(u,u+a.nodeSize):i.insertText(a.textContent,u,u+a.nodeSize))}),e.dispatch(i)}function Bn(e){const t=e.state.tr;t.doc.descendants((n,s)=>{if(n.type.name===me){const o=s+n.nodeSize;s===1&&t.doc.resolve(o).nodeAfter==null?t.delete(s,o):t.insertText(n.textContent,s,s+n.nodeSize)}}),t.steps.length>0&&e.dispatch(t)}function Je(e){const{active:t,range:n,queryText:s,onHintMatch:o}=e;if(o)return o(!t||!n?void 0:{text:s,range:n})}function Gn(e){const t=[];return e.descendants(n=>{n.type.name===me&&typeof n.attrs?.id=="string"&&t.push(n.attrs.id)}),t}function Ps(){return new Y({key:Ce,state:{init(){return fe()},apply(e,t,n,s){const o=e.getMeta(Ce),i={...fe(),...t,...o},r=e.selection;if(r.from!==r.to||s.doc.eq(n.doc))return Je(i),i;const c=r.$from,a=st(c,t.dismissedRange);return i.active=!!a&&!a.isDismissed,a&&(i.queryText=a.queryText,i.range=a.range,a.isDismissed&&(a.queryText===""&&t.queryText!==""?i.dismissedRange=void 0:i.dismissedRange=a.range)),Je(i),i}}})}class Wn extends en{constructor(t){super(),this.view=t,this.subscribe("focus",()=>this._store.setState({isFocused:!0})),this.subscribe("blur",()=>this._store.setState({isFocused:!1}))}fileInputHandle=null;_store=ft(t=>({isFocused:!1,autocompletions:[],showTaggingDropdown:!1,waveWidth:300,isInReasonMode:!1,rateLimitBannerFeature:null,setShowTaggingDropdown:n=>t({showTaggingDropdown:n})}));get store(){return this._store}_usedDictation=!1;_dictationEdited=!1;_dictationAssetPointer=null;_dictationAssetTTL=null;get usedDictation(){return this._usedDictation}set usedDictation(t){this._usedDictation=t}get dictationEdited(){return this._dictationEdited}set dictationEdited(t){this._dictationEdited=t}get dictationAssetPointer(){return this._dictationAssetPointer}set dictationAssetPointer(t){this._dictationAssetPointer=t}get dictationAssetTTL(){return this._dictationAssetTTL}set dictationAssetTTL(t){this._dictationAssetTTL=t}get element(){return this.view.dom}get document(){return this.view.dom.ownerDocument}isEmpty(){return this.view.state.doc.textContent.trim().length===0}isFocused(){return this.view.hasFocus()}trimLeadingText(t){const s=this.view.state.tr;let o=0;return s.doc.descendants((i,r)=>{if(i.isText&&i.text){if(typeof t=="string"&&i.text.startsWith(t))o=t.length;else if(t instanceof RegExp){const c=i.text.match(t);c?.index===0&&(o=c[0].length)}if(o){const c=i.text.substring(o).trimStart();o=i.text.length-c.length,s.delete(r,r+o)}}return!i.isLeaf}),o>0?(this.view.dispatch(s),!0):!1}replaceAll(t,n){const o=this.view.state.tr,i=[];o.doc.descendants((r,c)=>{!r.isText||r.text===void 0||i.push({node:r,pos:c})}),i.reverse(),i.forEach(({node:r,pos:c})=>{!r.isText||r.text===void 0||r.text.includes(t)&&o.insertText(r.text.replaceAll(t,n),c,c+r.text.length)}),this.view.dispatch(o)}appendText(t){this.view.dispatch(this.view.state.tr.insertText(t))}delete(t,n){this.view.dispatch(this.view.state.tr.delete(t,n))}focus(){this.view.hasFocus()||(this.view.focus(),this.view.dispatch(this.view.state.tr.setSelection(we.atEnd(this.view.state.doc)).scrollIntoView()))}setText(t){const{tr:n,schema:s}=this.view.state,o=t?s.nodes.paragraph.create(null,s.text(t)):s.nodes.paragraph.create();this.view.dispatch(n.replaceWith(0,this.view.state.doc.content.size,o)),this.view.hasFocus()&&this.view.dispatch(this.view.state.tr.setSelection(we.atEnd(this.view.state.doc)))}getContentLength(){return this.view.state.doc.content.size}getCurrentText(){return this.view.state.doc.textContent}hasMultipleLines(){let t=0;return this.view.state.doc.descendants(n=>{n.isBlock&&t++}),t>1}getContentToSend(){return Fn(this.view)}resize(){}isReady(){return!!this.view.state.doc}setPlaceholder(t){this.view.dispatch(this.view.state.tr.setMeta(oe,{placeholder:t}))}getSelectionStart(){return this.view.state.selection.ranges[0].$from.pos}setSelection(t,n){this.view.dispatch(this.view.state.tr.setSelection(we.create(this.view.state.doc,t,n))),this.view.focus()}isMenuSelectorActive(){return N.getState(this.view.state).active}registerKeyHandlers(t){Kn(this.view,t)}registerFileInput(t){this.fileInputHandle=t}openFileDialog(){this.fileInputHandle?.openFileDialog()}acceptLegacyKeydown(){return!1}subscribe(t,n){if(t==="change"){const s=()=>{this.usedDictation&&(this._dictationEdited=!0),n(void 0)};return Ge(this.view,s)}return this.view.dom?.addEventListener(t,n,{capture:!0}),()=>{this.view.dom?.removeEventListener(t,n,{capture:!0})}}useState(t){return w.useSyncExternalStore(n=>Ge(this.view,n),()=>t(this),()=>t(this))}getSystemHint(){return Gn(this.view.state.tr.doc)[0]??null}getKeywords(){return[...q.getState(this.view.state)?.matchedKeywords??[]]}removeKeywordDecorations(t){t.length!==0&&zn(t,this.view)}resetTrackingKeywords(t){jn(t,this.view)}addSystemHint(t,n,s=1,o=1){$n(this.view,t,n,s,o)}removeSystemHints(){Bn(this.view)}canShowAutocompletion(){const t=this.getSystemHint();return t===J.PictureV2||t===J.Tatertot||!this.isMenuSelectorActive()&&!t}}const Jn=ce({}),it=ce(void 0),Qn=ce(void 0),be=ce(0),Ee=ce(0),Is=({serverThreadId:e,clientThreadId:t,getIsDisabled:n,composerController:s,currentModelId:o,account:i,onReset:r,onInfer:c,isInferEnabledForModel:a})=>{const[u,d]=w.useState(!1),f=Ve(),g=Qe(f,"657118093").value,l=Number(g?.web_debounce_ms??400),m=pt(f,"209963048")&&["gpt-4o","auto"].includes(o),_=ht(),C=w.useRef(null),I=tn(({enableInferredJuice:v})=>v)||m||a,D=w.useRef(c);D.current=c;const F=w.useRef(0),O=w.useRef(0),b=yt(()=>Qn()),E=_t(t,v=>v?.modelId),K=w.useCallback(nn(v=>{if(n())return;Me.logEventWithStatsig("chatgpt_web_autoswitch_infer_called","chatgpt_web_autoswitch_infer_called",{is_paid_user:i?.hasPaidSubscription()});const T=v.length,y=T<5?"<5":T<=10?"5-10":T<=20?"10-20":T<=50?"30-50":"50+";if(x.count(A.DEFAULT,"chatgpt_web_autoswitch_infer_called",{prompt_length:y,is_paid_user:i?.hasPaidSubscription()?"true":"false"}),m)return;const Z=++F.current,X=Date.now();d(X);const le=Q(t),j=H.getCurrentNode(le);St.postAnonAware("/conversation/infer",{prompt:v,conversation_id:e??null,is_history_and_training_disabled:_,parent_message_id:j.message.id,auto_switcher_treatment_override:b,model_id:E},{additionalHeaders:{"x-conduit-token":C.current??""}}).then(k=>{if(C.current=k.conduit_token,n()||O.current>Z||s.getContentToSend().content.length<v.length)return;O.current=Z;const{effort_mode:he,debug_info:de,request_id:ee}=k;de&&Jn.set(de),ee&&it.set(ee),be.set(ye=>ye+1),Ee.set(v.length),D.current(he)}).finally(()=>{d(k=>k&&X<k?k:!1)})},l),[n,e,b]),U=w.useRef(void 0);return w.useEffect(()=>{if(!I||!(s instanceof Wn)){E&&E!==U.current&&(U.current=E);return}const v=()=>{const{content:T}=s.getContentToSend();n()||!I||(T?K(T):(C.current=null,r(),d(!1),++F.current,O.current=F.current))};return E&&E!==U.current&&(U.current=E,v()),s.subscribe("change",()=>{v()})},[I,n,s,K,c,r,e,_,E]),u!==!1},Vn="OAI-Echo-Logs",B={FOCUS_IN:0,FOCUS_OUT:1,COPY:2,PASTE:3,TOUCH_START:4,TOUCH_END:5},rt=[];function G(e){return()=>{rt.push({type:e,ts:Math.round(performance.now())})}}const Yn={focusin:G(B.FOCUS_IN),focusout:G(B.FOCUS_OUT),copy:G(B.COPY),paste:G(B.PASTE),touchstart:G(B.TOUCH_START),touchend:G(B.TOUCH_END)};function qs(e){const t=e??document.getElementById(et);for(const[n,s]of Object.entries(Yn))t?.removeEventListener(n,s),t?.addEventListener(n,s)}function Zn(){return{[Vn]:rt.slice(0,10).map(e=>`${e.type},${e.ts}`).join(",")}}function Xn(e,t,n,s,o,i){const r=ns(e,t,n,o,i);return ts(n,s,r)}const es=1e3*30,se=sn.getTracer("completion");function Te(e,t){x.count(A.DEFAULT,e,[{key:"prepare_sent",value:t&&t!=="none"?"true":"false"},{key:"prepare_succeeded",value:t==="success"?"true":"false"},{key:"prepare_failed",value:t==="failure"?"true":"false"}])}async function*ts(e,t,n){let s=!1,o=!1,i=!1,r=!1,c,a,u,d,f;se.startActiveSpan("completion.response",l=>{c=se.startSpan("completion.first_response"),a=se.startSpan("completion.first_token_including_tool_calls"),u=se.startSpan("completion.first_token_including_visible_content"),d=se.startSpan("completion.first_token"),f=l});let g=setTimeout(()=>{Me.logEvent("SSE Response Took Too Long to Come Back",{}),e.logCompletion({type:an.Error,error:{reason:"timeout",message:"SSE Response Took Too Long to Come Back"}})},es);try{t?.logTiming("prompt_submitted");for await(const l of n)yield l,l.type!=="connected"&&g&&(clearTimeout(g),g=null),l.type==="message"&&(e.onMessageUpdate(l.message),s||(s=!0,c?.end(),t?.logTiming("first_response")),!o&&l.message.author.role===ie.Assistant&&(o=!0,a?.end(),t?.logTiming("first_assistant_token")),!i&&l.message.author.role===ie.Assistant&&Tt(l.message)&&(i=!0,u?.end(),t?.logTiming("first_visible_content_token")),!r&&l.message.author.role===ie.Assistant&&Ct(l.message)&&(r=!0,d?.end(),t?.logTiming("first_message_token"))),l.type==="perf_stats"&&e.addServerPerfStats(l),l.type==="server_ste_metadata"&&e.addServerSteMetadata(l),l.type==="done"&&e.onStreamClose()}catch(l){throw g&&(clearTimeout(g),g=null),l}finally{f?.end()}}async function*ns(e,t,n,s,o){const{conduitToken:i,prepareState:r,model:c,f_completion:a}=t,u=Ke(3010482349,`${c}-AAAA`)||Ke(3240390095,`${c}-AAAA`),d=vt(e)?u?window.location.origin+"/backend-alt":window.location.origin+"/backend-api":window.location.origin+"/backend-anon";let f=`${d}/conversation`;a&&(f=`${d}/f/conversation`),n.onSentUserMessage();const g=on(f,{ctx:e,method:"POST",headers:{...Zn(),...wt(t.chatReq,t.turnstileToken,t.proofToken,null),...i?{"x-conduit-token":i}:{}},body:at(t),intercomEventOnError:"fetch-error:conversation:new-message",signal:s,observer:{onEvent:m=>{n.onStreamEvent(m.byteLength,m.isDoneEvent)},onClose:(m,_)=>{_&&x.count(A.DEFAULT,"conversation_api.client_request_error"),m==="completed"?(n.onStreamClose(),t.f_completion&&Te("conduit_f_conversation_api.success",r)):m==="aborted"?(n.handleAbort(_),t.f_completion&&Te("conduit_f_conversation_api.aborted",r)):(n.handleRawError(_ instanceof Error||typeof _=="string"?_:JSON.stringify(_)),Te("conduit_f_conversation_api.error",r))}}});a&&o&&ge(o,m=>{m.conduitToken=null,m.prepareState=null,m.lastPrepareTimestamp=null});const h=rn(g,m=>{n.stream_encoding=m});yield*ss(h)}async function*ss(e){let t=!1;for await(const n of e)if("response"in n)yield{type:"connected",serverRequestId:n.response?.headers?.get("Cf-Ray")??null};else{const s=is(n.data);s&&(s.type==="done"&&(t=!0),yield s)}t||(yield{type:"done"})}function at(e){const t="threadId"in e?e.threadId:void 0;return{action:e.completionType,messages:e.messages.length>0?e.messages.map(os):void 0,conversation_id:t,continue_from_shared_conversation_id:"continueFromSharedConversationId"in e&&t==null?e.continueFromSharedConversationId:void 0,continue_from_shared_post_id:"continueFromSharedPostId"in e?e.continueFromSharedPostId:void 0,fork_from_shared_post:"forkFromSharedPost"in e?e.forkFromSharedPost:void 0,parent_message_id:e.parentMessageId,model:e.model,timezone_offset_min:new Date().getTimezoneOffset(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,variant_purpose:e.completionMetadata?.variantPurpose,suggestions:e.completionMetadata?.suggestions?e.completionMetadata.suggestions.map(n=>ln(n)):void 0,chosen_suggestion:e.completionMetadata?.suggestion?{type:e.completionMetadata.suggestion.type,index:e.completionMetadata.suggestionIndex,source:e.completionMetadata.suggestion.type===Ue.Autocomplete?e.completionMetadata.suggestion.source:void 0,user_input:e.completionMetadata.suggestion.type===Ue.Autocomplete?e.completionMetadata.suggestion.userInput:void 0}:void 0,history_and_training_disabled:R(e.historyDisabled),conversation_mode:bt(e.completionMetadata?.conversationMode),force_paragen:R(e.forceParagen),force_paragen_model_slug:e.forceParagenModel,force_indepth_feedback:R(e.forceIndepthFeedback),force_rate_limit:R(e.forceRateLimit),reset_rate_limits:R(e.resetRateLimits),record_rendering:R(e.recordRendering),disable_system_content_toggling:R(e.disableSystemContentToggling),enable_message_followups:e.enableMessageFollowups,source:e.completionMetadata?.source,system_hints:e.completionMetadata?.systemHints,prefetch_ids:e.completionMetadata?.prefetchIds,supports_buffering:!0,supported_encodings:[cn.V1],conversation_origin:W(e.conversationOrigin),force_use_search:W(e.forceUseSearch),client_reported_search_source:e.completionMetadata?.searchSource,client_contextual_info:e.contextualInfo,paragen_stream_type_override:W(e.paragenStreamType==="none"?null:e.paragenStreamType),paragen_cot_summary_display_override:W(e.paragenCotSummaryDisplay==="none"?null:e.paragenCotSummaryDisplay),is_onboarding_conversation:R(e.isOnboardingConversation),effort_mode:W(e.effortMode),infer_request_id:W(e.inferRequestId),is_anon_mode:R(e.isAnonModeEnabled)}}function os(e){let t=e;return e.clientMetadata&&(t={...e},delete t.clientMetadata),t}function R(e){if(e===!0)return e}function W(e){if(e!=null)return e}function is(e){if("type"in e)switch(e.type){case"gizmo_inline_review":return{type:"gizmo_inline_review",gizmoId:e.gizmo_id};case"title_generation":return{type:"title_generation",title:e.title,conversation_id:e.conversation_id};case"moderation":return{type:"moderation",conversationId:e.conversation_id,messageId:e.message_id,isCompletion:e.is_completion,flagged:e.moderation_response.flagged,blocked:e.moderation_response.blocked,disclaimers:e.moderation_response.disclaimers,metadata:e.moderation_response.metadata};case"url_moderation":return{type:"url_moderation",conversationId:e.conversation_id,messageId:e.message_id,url:e.url_moderation_result.full_url,isSafe:e.url_moderation_result.is_safe};case"num_variants_in_stream":return{type:"num_variants_in_stream",num_variants_in_stream:e.num_variants_in_stream,display_treatment:e.display_treatment};case"perf_stats":case"conversation_detail_metadata":case"conversation_async_status":case"server_ste_metadata":return e;case"message_stream_complete":return{type:"done"};default:return}if(e.message)return{type:"message",message:e.message,conversationId:e.conversation_id}}async function Ds(e,t,n=[],s){if(!dn()||!un())return;const o=ke(e),i=Q(e),r=i?.conversationOrigin??null,c=H.getCurrentNode(i),a=i?.conduitToken??null,u=i?.prepareState??"none",d={threadId:o,prepareState:u,conduitToken:a,conversationOrigin:r,model:t,effortMode:i?.effortMode??void 0,completionType:Re.Next,completionMetadata:{systemHints:n,conversationMode:i?.mode??{kind:Et.PrimaryAssistant}},messages:[],parentMessageId:c.message.id},f=at(d),g={"x-conduit-token":a??"no-token"};try{ge(e,m=>{m.prepareState="sent",m.lastPrepareTimestamp=performance.now()});const l=await Mt.safePost("/f/conversation/prepare",{requestBody:f,additionalHeaders:g,authOption:kt.SendIfAvailable}),{conduit_token:h}=l;s(h)}catch(l){x.count(A.DEFAULT,"conduit_f_conversation_prepare_api_error"),Rt.addError(l),ge(e,h=>{h.conduitToken=null,h.prepareState="failure"})}}function Fs(e){const t=Ve(),n=Ze(),s=xt(),o=qn(),i=gn(),r=mn(),c=fn(d=>d.threads[e]?.modelSelection),a=c?.type===pn.EFFORT_MODE?c.effortMode:void 0,u=At(t,"269676899",{disableExposureLog:!0}).get("clear_all",!1);return w.useCallback(async function({requestedModelId:d,completionType:f=Re.Next,sourceEvent:g,eventSource:l,completionMetadata:h,extraStreamParams:m,parentMessageId:_,promptMessage:C,existingMessages:P,prependMessages:I,appendMessages:D,profiler:F,skipNotification:O}){const b=g?.timeStamp??performance.now(),E=l??(g?hn(g):"mouse"),K=new AbortController,U=Ht(),v=ke(e),T=`request-${e}-${U}`,y=Q(e),{conduitToken:Z=null,prepareState:X="none",lastPrepareTimestamp:le=null}=y??{},j=d??y?.modelId??yn(Ye(n)).id,k=H.findNode(y,p=>p.message.author.role===ie.Assistant||p.message.author.role===ie.Tool)==null,he=y?.continuingFromSharedConversationId!=null,de=!!y?.continuingFromSharedPostId,ee=_?H.getNode(y,_):P?.[0]?H.getParentNode(y,P[0].id):H.getCurrentNode(y),ye=ee.message.id??ee.id,Ae=[...P??[],...I??[],...C?[C]:[],...D??[]],_e=_n(t,e),te=new Sn({clientRequestId:T,gizmoType:_e,preflightTime:b});if(te.onUserMessages(Ae),_e===je.PROJECT&&k&&!u){const p=h?.systemHints;vn(t).set(mt=>({...mt,[e]:p??[]}))}const He=Pt(t),Pe=It(),z=new wn(t,T,n,y,e,_,I,C,D,f,j,a??y?.effortMode,E,He,b,o,_e===je.PROJECT,k,he,te,O??!1,Pe,de),ct=Tn(e);Cn(e)?.value===Fe.REALTIME&&await ct,qt.publish({kind:"requestCompletion"}),bn(e,{source:Dt.CLIENT,value:Fe.STREAMING}),Ft.addRequest(T,K,te),En.onCompletionRequestStarted(T),z.updateBeforeRequest();const lt=performance.now(),L=[],$=Ot()??(L.push("chatReq"),await Lt());$.force_login&&i({authType:"login"});const dt=ze.getEnforcementTokenSync($)??(L.push("turnstile"),await ze.getEnforcementToken($)),ut=Oe.getEnforcementTokenSync($)??(L.push("proofofwork"),await Oe.getEnforcementToken($));n.getQueriesData(Le)==null&&await n.ensureQueryData(Le);const Ie=L.includes("chatReq")?"false":"true",qe=L.includes("turnstile")?"false":"true",De=L.includes("proofofwork")?"false":"true";x.hist(A.DEFAULT,"chat_req_time",[{key:"wasChatReqSync",value:Ie},{key:"wasTurnstileSync",value:qe},{key:"wasProofofworkSync",value:De}],performance.now()-lt),Nt(Kt(),{eventName:"chatgpt_web_completion_integrity_checks",value:L.length===0?"true":"false",metadata:{wasChatReqSync:Ie,wasTurnstileSync:qe,wasProofofworkSync:De}}),Mn()&&await kn();const M=Rn();if(te.onCompletionStarted(f,j),z.preflightTime=performance.now()-b,r&&le!=null){const p=performance.now()-le;p<=6e4&&x.hist(A.DEFAULT,"fast_conversation_last_prepare_to_convo_client",[{key:"model_id",value:j},{key:"prepare_state",value:String(X)},{key:"has_conduit_token",value:Z!=null?"true":"false"}],p)}if(a??y?.effortMode){x.hist(A.DEFAULT,"chatgpt_web_autoswitcher_infer_calls_per_message",[],be()),be.set(0);const p=Ee();p!==0&&C?x.hist(A.DEFAULT,"chatgpt_web_autoswitcher_prompt_length_difference",[],Ut(C).length-p):x.count(A.DEFAULT,"chatgpt_web_autoswitcher_message_before_infer_completed"),Ee.set(0)}const gt=Xn(t,{conversationOrigin:y?.conversationOrigin??null,model:j,completionType:f,prepareState:X,conduitToken:Z,threadId:v,effortMode:a??y?.effortMode??void 0,inferRequestId:it(),continueFromSharedConversationId:y?.continuingFromSharedConversationId,continueFromSharedPostId:y?.continuingFromSharedPostId,forkFromSharedPost:y?.forkFromSharedPost,historyDisabled:He,isAnonModeEnabled:Pe,parentMessageId:ye,messages:Ae,chatReq:$,turnstileToken:dt,proofToken:ut,completionMetadata:h,contextualInfo:{is_dark_mode:s,time_since_loaded:Math.floor(performance.now()/1e3),page_height:window.innerHeight,page_width:window.innerWidth,pixel_ratio:window.devicePixelRatio,screen_height:window.screen.height,screen_width:window.screen.width},isOnboardingConversation:h?.isOnboardingConversation,forceParagen:M.forceParagen,forceParagenModel:M.forceParagen?M.forceParagenModel.value:void 0,forceRateLimit:M.forceRateLimit,resetRateLimits:M.resetRateLimits,recordRendering:M.recordRendering,disableSystemContentToggling:M.rebaseSystemMessageContent!=null,forceUseSearch:M.forceUseSearch??void 0,paragenStreamType:M.paragenStreamType,paragenCotSummaryDisplay:M.paragenCotSummaryDisplay,...r?{f_completion:!0}:{},...m},te,F,K.signal,e);try{for await(const p of gt)p.type==="connected"?z.handleStreamConnected(p):p.type!=="perf_stats"&&p.type!=="server_ste_metadata"&&z.handleResponse(p)}catch(p){jt(p)||K.signal.aborted?z.handleAbort(p):z.handleError(p)}},[e,n,u,t,a,o,r,s,i])}function Os({clientThreadId:e,conversationMode:t}){const n=zt(),s=w.useContext(xn),o=Ze(),i=An.useIsEnabled(e);return({nodeId:r,sourceEvent:c,requestedModelId:a,appendMessages:u,extraStreamParams:d})=>{const f=Q(e),g=H.getVariantIds(f,r),l=H.getParentPromptNode(f,r);if(!l)throw new Error("Regeneration must have parent prompt");const h=$t(o)??[],m=g?.length===1&&d?.forceUseSearch===void 0,_=Ye(o);let P=l.message.metadata?.system_hints||[];if(a){const F=Hn(_?.models,a),O=On({modelConfig:F,systemHints:h,isTemporaryChatEnabled:n}).map(b=>b.systemHint);P=P.filter(b=>O.includes(b))}i&&(d={...d??{},enableMessageFollowups:!0});const{systemHints:I,extraStreamParams:D}=Pn(P,d);s({completionType:Re.Variant,requestedModelId:a,sourceEvent:c,completionMetadata:{variantPurpose:m?"comparison_implicit":"none",conversationMode:t??Q(e)?.mode,systemHints:I,searchSource:d?.forceUseSearch===!0?$e.CONVERSATION_REGENERATE_WITH_SEARCH:d?.forceUseSearch===!1?$e.CONVERSATION_REGENERATE_WITHOUT_SEARCH:void 0},parentMessageId:l.id,appendMessages:u,extraStreamParams:D})}}function Ls(e){const t=xe(),n=e.useState(o=>o.getSystemHint());return t.size?t.values().next().value:n}function Ns(e,t){const{clearAllSystemHintModeTriggers:n,setThreadSystemHintMode:s}=Ln();return w.useCallback(({hint:o,enable:i})=>{n(),i&&s(o.systemHint,!0,{clientThreadId:t}),e.removeSystemHints()},[n,e,s,t])}function rs(e,t){return new Date(e).toLocaleDateString(t,{month:"long",day:"numeric"})}const Ks=({taskId:e,clientThreadId:t,onClose:n})=>{const s=Dn(),o=Bt(),i=Gt(a=>a.bySystemHint(J.Research)),r=In({taskId:e,intl:s,toaster:o}),c=w.useCallback(()=>{r.mutate(),ge(t,a=>{a.async_status=null}),Me.logEventWithStatsig("Pause Completion","chatgpt_pause_completion",{threadId:ke(t),currentLeafId:H.getCurrentNode(Q(t)).message.id,eventSource:"mouse"}),n()},[r,t,n]);return S.jsx(Wt,{open:!0,onOpenChange:a=>{a||n()},children:S.jsxs(Jt,{children:[S.jsx(Qt,{className:"border-token-border-medium radix-state-open:animate-show fixed inset-0 bg-black/25"}),S.jsxs(Vt,{className:"bg-token-main-surface-primary radix-state-open:animate-alertShow fixed start-1/2 top-1/2 flex max-h-[85vh] w-[90vw] max-w-lg -translate-x-1/2 -translate-y-1/2 flex-col gap-2 rounded-2xl shadow-2xl focus:outline-hidden",children:[S.jsx(Yt,{className:"p-4 pb-2 text-lg font-semibold md:p-6 md:pb-2",children:S.jsx(ne,{id:"caterpillar.message.modal.confirmCancelTaskTitle",defaultMessage:"Are you sure you want to stop researching?"})}),S.jsxs("div",{className:"flex flex-col gap-4 p-4 pt-0 md:p-6 md:pt-0",children:[S.jsx(Zt,{className:"text-base",children:S.jsx("span",{className:"mb-2",children:i?S.jsx(ne,{id:"caterpillar.message.modal.confirmCancelTaskDescription",defaultMessage:"Stopping now will still count as one deep research request. You have {remaining} more available until {resetDate}.",values:{remaining:i.remaining,resetDate:rs(i.reset_after,s.locale)}}):S.jsx(ne,{id:"caterpillar.message.modal.confirmCancelTaskDescriptionNoRateLimit",defaultMessage:"Stopping now will still count as one deep research request."})})}),S.jsxs("div",{className:"flex justify-end gap-2",children:[S.jsx(Ne,{color:"secondary",onClick:n,children:S.jsx(ne,{id:"caterpillar.message.modal.confirmCancelTaskCancelButton",defaultMessage:"Don't stop"})}),S.jsx(Ne,{color:"danger",className:"w-20",onClick:c,children:r.isPending?S.jsx(Xt,{}):S.jsx(ne,{id:"caterpillar.message.modal.confirmCancelTaskButton",defaultMessage:"Stop"})})]})]})]})]})})};export{Is as A,vs as B,Ks as C,ys as D,ps as E,Ts as F,ws as G,Ss as H,Nn as I,Wn as P,et as T,xe as a,qs as b,Os as c,Ln as d,me as e,Be as f,Es as g,Ps as h,bs as i,Cs as j,Ms as k,hs as l,Rs as m,Ds as n,Ns as o,xs as p,Ls as q,_s as r,As as s,fs as t,Fs as u,rs as v,ot as w,ks as x,We as y,Hs as z};
//# sourceMappingURL=ku4zsoy6w4wkp690.js.map
