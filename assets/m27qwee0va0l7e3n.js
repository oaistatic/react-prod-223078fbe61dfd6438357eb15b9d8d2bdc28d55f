import{i as ne,r as o,j as e,M as I,a6 as me,a5 as T,v as as,e as Te,as as rs}from"./b8ijctzpgh0s7wpx.js";import{aX as Se,jr as os,cs as is,js as ls,jA as cs,nh as ds,ds as us,f1 as Ae,uc as ms,ud as xs,mn as fs,t as xe,oi as Le,gv as ps,gw as gs,jv as hs,gy as ys,gz as js,ue as K,S as Ns,gJ as bs,aZ as ws,O as Es,gn as Ss,gC as Rs,bY as vs,uf as ks,rH as Cs}from"./krbmwir12ubt4od1.js";import{ab as Os,ac as ke,B as J,ak as te,s as z,N as W,c as E,ad as _e,aI as De,aF as Pe,b as Fe,d as Ms,ht as Is,bh as Ts,eR as As,fM as Ls,fa as _s,eo as Ds,gz as Ps,dV as Fs,hu as Bs,S as Be,bS as je,z as Us}from"./citrwydz0bgriwlc.js";import{T as Re,M as j,l as le,n as ee,o as zs,p as ce,q as $,g as Ws,i as $s,d as Hs}from"./by50z05oxjtbvc0n.js";import{a4 as Gs,a5 as qs,a6 as Xs,e as Ys}from"./eqsdgkbw87fpj3r7.js";import{L as Ks}from"./gy64pge8qevmvg7e.js";const Ue=({origin:s,url:t})=>e.jsxs("div",{"aria-label":t,className:"w-full min-w-0 pe-4 text-start whitespace-nowrap",children:[e.jsx("span",{"aria-hidden":!0,className:"text-token-text-primary",children:s}),e.jsx("span",{"aria-hidden":!0,className:"text-token-text-tertiary",children:t.replace(s,"")})]}),Zs=({request:s,isDenied:t=!1,onClick:n})=>{const[{width:a},r]=cs();return e.jsxs("button",{ref:r,className:"group relative z-0 my-1 flex w-full items-center",onClick:n,children:[e.jsx("div",{className:"sticky start-0 z-[-1] w-0",children:e.jsx("div",{className:"absolute top-0 hidden h-8 -translate-y-1/2 bg-gray-100 group-hover:block",style:{width:a}})}),e.jsx("div",{className:"bg-token-main-surface-primary text-token-text-secondary sticky start-0 z-10 flex h-8 shrink-0 items-center px-2 group-hover:bg-gray-100",children:t?e.jsx(ds,{className:"icon-md text-red-500"}):e.jsx(us,{className:"icon-md text-green-500"})}),e.jsx(Ue,{...s})]})},Js=({title:s,requests:t})=>{const n=ne(),[a,r]=o.useState(()=>new Set),l=()=>{for(const{requestId:i,approve:u,deny:g}of t)a.has(i)?g():u()},c=()=>{for(const i of t)i.deny()},m=i=>{r(u=>{const g=new Set(u);return g.has(i)?g.delete(i):g.add(i),g})},d=t.length-a.size;return e.jsx(Os,{testId:"modal-confirm-fetch-request",isOpen:!0,shouldIgnoreClickOutside:!0,onClose:l,type:"success",title:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-xl",children:e.jsx(I,{id:"VmMpF1",defaultMessage:"Allow network access?"})}),e.jsx(Se,{side:"top",contentClassName:"max-w-2xs!",label:e.jsx(I,{id:"WT7tgj",defaultMessage:"Learn more about network requests in canvas"}),children:e.jsx(J,{icon:is,openNewTab:!0,onClick:()=>os.logButtonClick(ls.LEARN_MODE_ABOUT_NETWORK_REQUESTS),as:"a",color:"ghost",size:"small",className:"text-token-text-secondary aspect-square p-1!",to:"https://help.openai.com/en/articles/9930697-what-is-the-canvas-feature-in-chatgpt-and-how-do-i-use-it#h_cd52fdbc16"})})]}),description:e.jsxs("div",{className:"mt-3 flex flex-col gap-3",children:[e.jsx("span",{className:"text-token-text-primary block",children:e.jsx(I,{id:"qk11AX",defaultMessage:"{title} is trying to connect to the network. If you don’t recognize {numRequests, plural, one {this request} other {any of these requests}}, don’t allow this app access to the network.",values:{title:`"${s}"`,numRequests:t.length}})}),e.jsx("div",{className:"flex max-w-full flex-col",children:t.length>1?e.jsx("ul",{className:"border-token-border-default relative flex max-h-48 flex-col overflow-x-auto overflow-y-auto rounded-lg border",children:t.map(i=>{const{requestId:u}=i;return e.jsx("li",{children:e.jsx(Zs,{request:i,isDenied:a.has(u),onClick:()=>m(u)})},u)})}):e.jsx("div",{className:"no-scrollbar bg-token-main-surface-secondary overflow-x-auto rounded-lg p-2",children:e.jsx(Ue,{...t[0]})})})]}),primaryButton:e.jsx(ke.Button,{disabled:d===0,title:t.length>1?n.formatMessage({id:"xpKkWv",defaultMessage:"Allow selected ({count})"},{count:d}):n.formatMessage({id:"ZeMrpd",defaultMessage:"Allow"}),color:"primary",onClick:l}),secondaryButton:e.jsx(ke.Button,{title:n.formatMessage({id:"TjJzqR",defaultMessage:"{count, plural, one {Deny} other {Deny all}}"},{count:t.length}),color:"secondary",onClick:c})})},Vs=({instrument:s})=>{switch(s.type){case"hist":return z.hist(W.WEB_SANDBOX,s.label,s.tags,s.value);case"count":return z.count(W.WEB_SANDBOX,s.label,s.tags,s.count);case"error":return te.addError(s.error)}},ze=({size:s=60,thickness:t=1/16,checkpoints:n,activeCheckpointId:a,isComplete:r=!1,onTransitionComplete:l,color:c})=>{const[m,d]=o.useState(0),i=n.findIndex(N=>N.id===a),u=o.useRef(null),g=n[i];o.useEffect(()=>{if(!g||r)return;const N=n.length,f=i*100/N,v=(i+1)*100/N;d(f);let O=null,w=null;const p=5/g.estimatedTime,S=_=>{w==null&&(w=_);const F=_-w;if(F!==0){const A=v-f,P=f+A*(1-Math.exp(-p*F));d(Math.min(P,v-1e-4))}O=window.setTimeout(()=>{u.current=requestAnimationFrame(S)},16)};return u.current=requestAnimationFrame(S),()=>{O!=null&&window.clearTimeout(O),u.current!=null&&cancelAnimationFrame(u.current)}},[i,r]);const x=()=>{r&&l?.()};return e.jsx(Ae,{sizeOverride:s,className:E(c==null&&"text-primary",c==="dark"&&"text-back",c==="light"&&"text-white"),thickness:t,backgroundStrokeClassName:E(c==null&&"stroke-[rgba(0,0,0,0.1)] dark:stroke-[rgba(0,0,0,0.32)]",c==="dark"&&"stroke-[rgba(0,0,0,0.32)]",c==="light"&&"stroke-[rgba(0,0,0,0.1)] "),percentage:r?100:m,onTransitionEnd:x,transitionDuration:"50ms",transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})},Qs=({checkpoints:s,activeCheckpointId:t,isIndeterminate:n=!1,isComplete:a})=>{const[r,l]=o.useState(a);return o.useEffect(()=>{l(a)},[t]),e.jsx(me,{children:(t!=null&&!r||n)&&e.jsxs(T.div,{initial:{opacity:0},exit:{opacity:0},animate:{opacity:1},className:"bg-token-main-surface-primary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",children:[n?e.jsx(Ae,{percentage:30,thickness:1/12,className:"text-primary animate-spin",backgroundStrokeClassName:"dark:stroke-[rgba(255,255,255,0.4)] stroke-[rgba(0,0,0,0.1)]",sizeOverride:12}):t&&e.jsx(ze,{size:12,thickness:1/12,checkpoints:s,activeCheckpointId:t,isComplete:a,onTransitionComplete:()=>l(!0)}),e.jsxs("span",{className:"text-token-text-secondary flex items-baseline text-sm",children:[e.jsx(I,{id:"zfcWbe",defaultMessage:"Updating"}),e.jsx(Re,{gap:1.5,padding:2,size:2})]})]})})};function et(s){let t=null;const n=[];let a=!1;return s.on("message",r=>{t?(t({value:r,done:a}),t=null):n.push(r),r.type===j.RUN_COMPLETE&&(a=!0)}),{[Symbol.asyncIterator](){return this},next(){if(n.length>0){const r=n.shift();return Promise.resolve({value:r,done:a})}return a?Promise.resolve({value:void 0,done:a}):new Promise(r=>{t=r})}}}const st="web-sandbox.oaiusercontent.com",Ne=`https://${st}`,{origin:tt}=new URL(Ne),nt=[tt,"https://cdn.jsdelivr.net","https://cdn.tailwindcss.com","https://esm.sh","https://unpkg.com","https://pypi.org","https://files.pythonhosted.org"];function Ce(){let s=null;const t=new Promise(n=>s=n);return{resolve:s,promise:t}}const We=()=>{const[s,t]=o.useState(Ce);return[s,o.useCallback(()=>t(Ce()),[])]},$e=()=>ms(De.getItem(Pe.CODE_EXECUTION_DOMAIN_ALLOW_LIST),t=>xs(t,{origin:xe,expiresAt:fs}),[]).filter(({expiresAt:t})=>t>=Date.now()),Oe=(s,t)=>{const{origin:n}=new URL(s);let a=[...nt];const r=$e().map(({origin:l})=>l);return t&&(a=a.concat(r)),a.includes(n)},at=({sessionId:s,networkAccessDeniedMessage:t,disableNetworkRequests:n,unsafeAllowAllNetworkRequests:a})=>{const r=_e(),l=ne(),c=o.useRef(null),m=o.useRef(null),d=o.useRef(null),[i,u]=o.useState([]),g=o.useCallback(w=>m.current?.postMessage(w),[]),x=o.useCallback(w=>d.current?.postMessage(w),[]);o.useEffect(()=>()=>{x({type:le.DISCONNECT,sessionId:s})},[s]);const N=o.useCallback(({url:w,requestId:p})=>{try{if(a||Oe(w,!n))return x({type:le.FETCH_RESPONSE,isApproved:!0,requestId:p});if(n)return r.danger(t??l.formatMessage({id:"Lp7cKY",defaultMessage:"Network access is disabled."}));z.count(W.WEB_SANDBOX,"network_access_requested");const{origin:S}=new URL(w),_=A=>{z.count(W.WEB_SANDBOX,`network_access_request.${A?"allow":"deny"}`),x({type:le.FETCH_RESPONSE,isApproved:A,requestId:p}),u(P=>P.filter(L=>!a&&!Oe(L.url,!n)&&L.requestId!==p))},F=()=>{De.setItem(Pe.CODE_EXECUTION_DOMAIN_ALLOW_LIST,[...$e(),{origin:S,expiresAt:Date.now()+90*24*60*60*1e3}]),_(!0)};u(A=>[...A,{url:w,origin:S,requestId:p,approve:F,deny:()=>_(!1)}])}catch(S){te.addError(S),x({type:le.FETCH_RESPONSE,isApproved:!1,requestId:p})}},[n,x,r,t,l,a]),[f,v]=We(),O=o.useCallback(async(w,p)=>{if(w.type===ee.SW_NOT_SUPPORTED)z.count(W.WEB_SANDBOX,"sw_not_supported"),f.resolve?.();else{m.current=p[0],d.current=p[1],d.current.onmessage=S=>{S.data.type==="ready"?f.resolve?.():N(S.data)};try{const{token:S}=await Fe.safeGet("/public/code_execution_challenge",{authOption:Ms.Anonymous,parameters:{query:{relay_client_id:w.clientId}}});g({type:zs.SW_RECONNECT_RESPONSE,reconnectId:w.reconnectId,sessionId:s,token:S})}catch(S){te.addError(S)}}},[N,g,f,s]);return{relayRef:c,relayInitPromise:f,resetRelayInitPromise:v,handleMessageFromRelay:O,pendingFetchRequests:i}},rt="https://persistent.oaistatic.com/canvas/loop-swirl.mp4",ot="https://persistent.oaistatic.com/canvas/loop-swirl-poster.jpg",Q=90,it=({title:s,checkpoints:t,activeCheckpointId:n,isComplete:a,onTransitionComplete:r})=>{const[l,c]=o.useState(!1),m=t.findIndex(u=>u.id===n),d=t[m],i=()=>{r?.(),c(!0)};return e.jsx(T.div,{className:"relative flex h-full w-full items-center justify-center",transition:{type:"spring",bounce:0},children:e.jsxs(T.div,{className:"flex -translate-y-12 flex-col items-center gap-3",style:{minWidth:Q,height:Q},initial:{opacity:0},animate:{opacity:1},transition:{type:"spring",duration:.5,bounce:0},children:[e.jsxs(T.div,{className:"bg-token-main-surface-primary absolute overflow-hidden rounded-3xl shadow-2xl",initial:!1,animate:{width:Q,height:Q,opacity:l?0:1},transition:{type:"spring",duration:.56,bounce:0},children:[e.jsx("video",{muted:!0,loop:!0,autoPlay:!0,playsInline:!0,src:rt,poster:ot,className:E("absolute inset-0 z-0 h-full w-full object-cover transition-opacity duration-200")}),e.jsx("div",{className:E("relative z-10 flex h-full w-full items-center justify-center",l?"opacity-0":"opacity-100"),children:e.jsx(ze,{color:"light",checkpoints:t,activeCheckpointId:n,isComplete:a,onTransitionComplete:i,thickness:1/12})})]}),e.jsxs(T.div,{className:E("flex flex-col items-center transition-opacity duration-200",a?"opacity-0":"opacity-100"),style:{translateY:Q+20},children:[e.jsx("span",{className:"text-token-text-primary font-semibold",children:s}),d&&e.jsx(T.span,{className:"text-token-text-secondary flex items-baseline",children:e.jsx("span",{className:"loading-shimmer",children:d.label})})]})]})})},Me=({sessionId:s})=>"?"+[`sessionId=${s}`,""].filter(Boolean).join("&"),Ie=[{id:$.INITIALIZING,label:"Initializing environment",estimatedTime:1e3},{id:$.INSTALLING_PACKAGES,label:"Installing packages",estimatedTime:2e3},{id:$.RUNNING_CODE,label:"Ready",estimatedTime:1}],lt=()=>Ls()?"ios":_s()?"windows":Ds()?"android":Ps()?"safari":Fs()||Bs()?"chrome":"unknown",ct=({isShare:s=!1,disableNetworkRequests:t=!1,unsafeAllowAllNetworkRequests:n=!1,networkAccessDeniedMessage:a,visuallyHidden:r=!1,isCodeUpdating:l=!1,enableTransition:c=!1,disablePermissions:m=!1,title:d,onChangeBackgroundColor:i},u)=>{const[g,x]=o.useState(0),[N]=o.useState(()=>crypto.randomUUID()),{pendingFetchRequests:f,handleMessageFromRelay:v,relayInitPromise:O,resetRelayInitPromise:w,relayRef:p}=at({sessionId:N,disableNetworkRequests:t,networkAccessDeniedMessage:a,unsafeAllowAllNetworkRequests:n}),S=o.useRef(null),[_,F]=We(),A=o.useMemo(()=>Promise.all([_.promise,O.promise]),[_,O]),[P,L]=o.useState(null),[G,Y]=o.useState(!1),V=o.useRef(null),q=o.useRef(new Map),B=o.useRef(null),D=o.useCallback(h=>{V.current?.postMessage(h)},[]),Z=o.useCallback(()=>{const h=q.current.keys();L(null),Y(!1),i?.(null);for(const y of h)D({type:ce.STOP_CODE,runId:y});B.current=null},[D,i]),ae=o.useCallback(()=>{w(),F(),x(h=>h+1),L(null),Y(!1),B.current=null},[w,F]),he=o.useCallback(async function*({code:h,language:y}){if(L($.INITIALIZING),z.count(W.WEB_SANDBOX,`${y}.eval`),await A,q.current.size!==0)return Z();const k=as(),R=new Is;q.current.set(k,R);const U={code:h,language:y,type:ce.RUN_CODE,runId:k};B.current={runId:k,language:y},D(U);for await(const C of et(R))C&&C.type===j.ENVIRONMENT_STATUS&&(L(C.status),c||Y(C.status===$.RUNNING_CODE)),C?.type===j.ERROR?z.count(W.WEB_SANDBOX,`${y}.error`):C?.type===j.RUN_COMPLETE&&C.wasFatalError&&z.count(W.WEB_SANDBOX,`${y}.fatal_runtime_error`),C&&!Le([j.READY],C.type)&&(yield C);L(null),Y(!1),q.current.delete(k)},[A,c,D,Z]),re=o.useCallback(async h=>{await A,D({type:ce.PREPARE_ENVIRONMENT,language:h})},[A,D]),oe=h=>{B.current&&D({type:ce.RUN_CODE,code:h,...B.current})};o.useImperativeHandle(u,()=>({stop:Z,evalAsync:he,updateCode:oe,prepareEnvironment:re})),o.useEffect(()=>Ts(window,{message:h=>{const{data:y,ports:k}=h,{type:R}=y,U=h.source===p.current?.contentWindow,C=h.source===S.current?.contentWindow;if(!U&&!C)return;if(R===j.ENVIRONMENT_ERROR)return te.addError("Code execution environment error",y.error),y.error.name==="ServiceWorker"&&z.count(W.WEB_SANDBOX,"service_worker_connection_failure",[{key:"agent",value:lt()},{key:"is_share",value:String(s)}]),y.runId!=null&&y.runId===B.current?.runId&&z.count(W.WEB_SANDBOX,`${B.current.language}.environment_error`),ae();if(U&&(y.type===ee.SW_NOT_SUPPORTED||y.type===ee.SW_RECONNECT))return v(y,k);if(U||!C||R===ee.SW_RECONNECT||R===ee.SW_NOT_SUPPORTED)return;if(V.current=k[0],R===j.READY)return _.resolve?.();if(R===j.SET_BACKGROUND_COLOR)return i?.(y.backgroundColor);if(R===j.INSTRUMENT)return Vs(y);const{runId:M}=y,X=M&&q.current.get(M);X?X.emit("message",y):te.addError("Code execution error: missing event emitter",{messageData:h.data})}}),[i,ae,v,O,p,_,N,s]);const ie={type:"spring",duration:G&&c?.56:0,delay:G?.12:0,bounce:0},b=m?"":"midi";return e.jsxs(As,{children:[e.jsx("iframe",{title:"relay","aria-hidden":"true",className:"fixed h-0 w-0",allow:b,ref:p,src:`${Ne}/relay.html${Me({sessionId:N})}`},`relay-${g}`),e.jsxs("div",{className:E("relative flex",r?"fixed h-0 w-0":"h-full w-full"),children:[!r&&P!=null&&c&&e.jsx(it,{isComplete:P===$.RUNNING_CODE,onTransitionComplete:()=>Y(!0),activeCheckpointId:P,title:d,checkpoints:Ie}),e.jsx(T.div,{className:E("bg-token-main-surface-primary absolute inset-0 m-auto origin-center overflow-hidden",G?"pointer-events-auto":"pointer-events-none"),animate:{opacity:G?1:0,...G?{scale:1}:{scale:.95}},transition:ie,children:e.jsx(T.iframe,{title:d,className:"h-full w-full overflow-hidden",transition:ie,"aria-hidden":r?"true":void 0,allow:b,src:`${Ne}/index.html${Me({sessionId:N})}`,sandbox:"allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox",ref:S,tabIndex:-1},`sandbox-${g}`)}),G&&e.jsx(Qs,{isIndeterminate:l,isComplete:P===$.RUNNING_CODE,activeCheckpointId:P,checkpoints:Ie})]}),f.length>0&&e.jsx(Js,{title:d,requests:f})]})},_t=o.forwardRef(ct),dt=({onClose:s,title:t,actions:n,showBorder:a=!1})=>e.jsxs("div",{className:E("bg-token-main-surface-primary flex items-center justify-between border-b py-2 ps-2 pe-2.5",{"border-token-border-xlight":a,"border-transparent":!a}),children:[e.jsx("div",{className:"text-token-text-primary flex items-center gap-2 ps-4 text-sm select-none",children:t}),e.jsxs("div",{className:"flex items-center gap-2",children:[n.map(({tooltip:r,icon:l,onClick:c},m)=>{const d=e.jsx(J,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",icon:l,onClick:c},m);return r?e.jsx(Se,{label:r,children:d},m):d}),e.jsx(J,{size:"small",color:"ghost",as:"button",className:"text-token-text-primary aspect-square p-1!",onClick:s,icon:Be})]})]}),ut=({onDrag:s,onDragEnd:t,onDoubleClick:n})=>e.jsx(T.div,{drag:"y",className:"bg-token-text-quaternary absolute top-[-2px] z-10 h-[4px] w-full cursor-ns-resize opacity-0",whileHover:{opacity:.5},whileDrag:{opacity:.75,height:"8px",top:"-4px"},transition:{type:"tween",duration:.1},style:{x:0,y:0,transform:"translateY(0px)"},dragMomentum:!1,dragSnapToOrigin:!1,dragElastic:!1,dragConstraints:{left:0,right:0,top:0,bottom:0},onDrag:(a,r)=>{s?.(r)},onDragEnd:t,onDoubleClick:n}),mt=({textdocTitle:s,onClickViewConsole:t,onClickFix:n,onDismiss:a})=>e.jsxs(T.div,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"border-token-border-default bg-token-main-surface-primary absolute end-2 bottom-2 flex w-fit max-w-80 flex-col gap-4 rounded-xl border px-4 py-4 shadow-xl",children:[e.jsxs("div",{className:"flex items-start",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"text-sm font-semibold",children:e.jsx(I,{id:"ObCQBq",defaultMessage:"Cannot preview your code"})}),e.jsx("div",{className:"text-sm",children:e.jsx(I,{id:"3ZeoP8",defaultMessage:"An error occured while trying to run {name}",values:{name:s}})})]}),e.jsx(J,{size:"small",color:"ghost",as:"button",className:"text-token-text-tertiary -m-1! aspect-square p-0!",onClick:a,icon:Be})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(J,{size:"small",color:"secondary",onClick:t,children:e.jsx(I,{id:"Fch32I",defaultMessage:"View console"})}),e.jsx(J,{size:"small",color:"primary",onClick:n,children:e.jsx(I,{id:"HRfYX0",defaultMessage:"Fix bug"})})]})]}),He=(s,{name:t,message:n,line:a,stack:r})=>{const l=a!=null?`

Error occured in:
${s.split(`
`).slice(a-1,a+1).join(`
`)}`:"";return`${t}: ${n}

Stack:
${r.join("")}${l}`},ye=new Ks({capacity:5}),xt=async(s,t,n)=>{const a=He(t,n.error),r=xe(ye.get(a));if(ye.get(a))return r;const{hint:l}=await Fe.safePost("/textdoc/{textdoc_id}/code/hint",{parameters:{path:{textdoc_id:s}},requestBody:{error:a,line:n.error.line??-1}});return ye.set(a,l),l},Ge=s=>Le([j.ERROR,j.LOG,j.OUTPUT],s.type),qe=s=>s.type===j.OUTPUT&&Xe(s.output),Xe=s=>typeof s=="string"&&s.startsWith("data:image/png;"),se=({as:s="li",contentBefore:t,contentAfter:n,disableEntryAnimation:a=!1,hasHint:r=!1,bottomBorder:l=!1,isHintOpen:c=!1,isSticky:m=!1,onClick:d,children:i})=>{const u=!!d,g=s==="div"?T.div:T.li;return e.jsxs(g,{initial:a?!1:{opacity:0},animate:{opacity:1},transition:{duration:.32},role:u?"button":void 0,className:E("bg-token-main-surface-primary flex items-start justify-between py-1.5 ps-6 pe-4 font-mono text-sm whitespace-pre",l&&"border-token-border-xlight border-b",m&&"sticky top-0 z-10",u&&"cursor-pointer",u&&r&&"hover:bg-red-500/10",u&&!r&&"hover:bg-gray-50 dark:hover:bg-gray-700",r&&c&&"bg-red-500/10"),onClick:u?d:void 0,children:[t&&e.jsx("div",{className:"me-3 flex h-6 w-5 items-start",children:t}),e.jsx("div",{className:"flex min-h-6 min-w-0 flex-1 items-start justify-start gap-2 leading-6",children:i}),n&&e.jsx("div",{className:"ms-3 flex min-h-6 items-start leading-6",children:n})]})};var H=(s=>(s.LOADING="loading",s.READY="ready",s.RESOLVED="resolved",s))(H||{});const Ye=({hint:s,onClickFix:t,isOpen:n,onOpenChange:a})=>{const r=o.useRef(null),l=ne();return s?e.jsx("div",{className:"relative flex items-center font-sans",onClick:c=>c.stopPropagation(),children:e.jsxs(ps,{open:n,onOpenChange:a,children:[e.jsx(gs,{asChild:!0,ref:r,children:s.status==="resolved"?e.jsx("div",{className:"flex h-5 w-5 items-center",children:e.jsx(hs,{className:"text-token-text-tertiary",size:16})}):e.jsx("button",{className:"h-5 w-5",disabled:s.status==="loading",children:s.status==="loading"?e.jsx(Gs,{}):e.jsx(qs,{position:"static",isError:!0,count:1,offsetY:0})})}),e.jsx(me,{children:n&&e.jsx(ys,{forceMount:!0,container:r.current?.ownerDocument.body,children:e.jsx(js,{side:"top",align:"start",alignOffset:-4,sideOffset:10,children:e.jsx(Xs,{position:"static",translateY:0,right:0,isFocused:!0,onDismiss:()=>a?.(!1),onAccept:c=>{a?.(!1),t?.(c)},comment:s,acceptButtonLabel:l.formatMessage({id:"Dl9vBh",defaultMessage:"Fix bug"})})})})})]})}):e.jsx("div",{className:"w-5"})},fe=s=>Array.isArray(s)||K(s)||s instanceof Map||s instanceof Set,pe=s=>s==null||typeof s=="string"||typeof s=="number"||typeof s=="boolean",Ke=s=>K(s)?Object.entries(s):Array.from(s.entries()),Ze=s=>`${typeof s}:${typeof s=="object"?JSON.stringify(s):s}`,ft=({isPreview:s=!1,value:t})=>{const[n,a]=o.useState(!1);return pe(t)?e.jsx(ge,{value:t,depth:0}):fe(t)?e.jsxs("span",{className:E("relative z-0 max-w-full font-mono text-sm leading-6",n&&"w-full flex-auto"),children:[e.jsxs("span",{role:"button",className:"group/row flex flex-wrap items-center gap-x-1 italic",onClick:()=>a(!n),children:[!s&&e.jsx(ss,{isExpanded:n}),e.jsx(Ve,{value:t,depth:0}),e.jsx(we,{value:t})]}),n&&!s&&e.jsx("div",{className:"ps-6",children:e.jsx(Qe,{value:t,depth:0})})]}):e.jsx("span",{className:"truncate",children:String(t)})},Je=({value:s,depth:t=0})=>fe(s)?e.jsx(Qe,{depth:t,value:s}):pe(s)?e.jsx(ge,{depth:t,value:s}):e.jsx("span",{className:"truncate",children:String(s)}),Ve=({value:s,depth:t=0})=>{const n=Array.isArray(s),a=Ke(s);return e.jsxs("div",{className:"inline-flex max-w-fit min-w-0 grow basis-0",children:[!K(s)&&e.jsx(be,{isShort:!0,isSecondary:!0,collection:s}),n?"[":"{",e.jsx("span",{className:"inline-flex max-w-fit min-w-0 shrink grow basis-0 overflow-hidden",children:a.map(([r,l],c)=>{let m=null;return fe(l)?m=e.jsx(be,{collection:l}):pe(l)?m=e.jsx(ge,{truncate:!0,depth:t+1,value:l}):m=e.jsx(Je,{depth:t+1,value:l}),e.jsxs(o.Fragment,{children:[(K(s)||s instanceof Map)&&e.jsx("span",{className:"text-token-text-secondary min-w-[2em] shrink truncate whitespace-pre",children:e.jsx(es,{value:s,propertyKey:r})}),m,c<a.length-1&&e.jsx("span",{className:"whitespace-pre",children:", "})]},Ze(r))})}),n?"]":"}"]})},Qe=({value:s,depth:t=0})=>{const[n,a]=o.useState(()=>new Set),r=Ke(s);return e.jsx("ol",{className:"flex flex-col ps-6 font-mono",children:r.map(([l,c])=>{const m=Ze(l),d=n.has(m),i=fe(c),u=()=>{a(g=>{const x=new Set(g);return x.has(m)?x.delete(m):x.add(m),x})};return e.jsxs("li",{className:E("flex ps-1 whitespace-nowrap",i&&"flex-col",!i&&"group/row flex-wrap"),onClick:g=>g.stopPropagation(),children:[e.jsxs("span",{onClick:i?u:void 0,role:i?"button":void 0,className:E("group/row z-10 -ms-1 min-w-0 items-center gap-x-1",i?"flex":"inline-flex"),children:[i&&e.jsxs(e.Fragment,{children:[e.jsx(pt,{}),e.jsx(ss,{shiftLeft:!0,isExpanded:d})]}),e.jsx("span",{className:E("font-bold",(K(s)||Array.isArray(s))&&"text-red-900 dark:text-blue-400"),children:e.jsx(es,{value:s,propertyKey:l})}),i&&!d&&e.jsx(Ve,{value:c,depth:t+1}),i&&d&&e.jsx(be,{isSecondary:!0,collection:c}),i&&e.jsx(we,{value:c})]}),(!i||d)&&e.jsx(Je,{value:c,depth:t+1}),(typeof c=="string"||typeof c=="number")&&e.jsx(we,{value:c})]},m)})})},ge=({value:s,truncate:t=!1})=>typeof s=="string"?e.jsxs("span",{className:E("dark:text-blue-75 text-red-500",t&&"max-w-fit min-w-[2em] shrink-0 grow basis-0 overflow-hidden text-ellipsis whitespace-nowrap",!t&&"break-words break-all whitespace-normal"),children:["'",s,"'"]}):e.jsx("span",{className:E("whitespace-nowrap",s==null?"text-token-text-secondary":"dark:text-brand-purple-600 text-blue-500"),children:String(s)}),pt=()=>e.jsx("span",{className:"absolute start-0 end-0 z-[-1] h-6 rounded-md group-hover/row:bg-gray-50 dark:group-hover/row:bg-gray-700"}),be=({collection:s,isSecondary:t=!1,isShort:n=!1})=>{let a=null;return Array.isArray(s)&&s.length>0?a=n?`(${s.length})`:`Array(${s.length})`:s instanceof Set?a=`Set(${s.size})`:s instanceof Map?a=`Map(${s.size})`:K(s)&&(a="{…}"),a&&e.jsx("span",{className:E(t&&"text-token-text-secondary"),children:a})},es=({value:s,propertyKey:t})=>K(s)||Array.isArray(s)?`${xe(t)}: `:s instanceof Map?e.jsxs("span",{className:"inline-flex items-center gap-1",children:[pe(t)?e.jsx(ge,{value:t,depth:0}):e.jsx("span",{className:"text-token-text-secondary",children:JSON.stringify(t)}),e.jsx(ws,{className:"icon-sm text-token-text-secondary"})]}):null,ss=({isExpanded:s,shiftLeft:t=!1})=>e.jsx("button",{className:E("flex h-5 shrink-0 items-center overflow-hidden",t&&"ms-[-16px]"),children:e.jsx(Ns,{className:E("icon-sm text-token-text-secondary transition-transform",s&&"rotate-90")})}),we=({value:s})=>{const t=_e(),n=()=>{Es(JSON.stringify(s),t)};return e.jsx("span",{className:E("text-token-text-secondary relative inline-block h-4 self-center opacity-0 transition-opacity","group-hover/row:opacity-100 group-hover/row:delay-500","hover:after:bg-token-main-surface-tertiary after:pointer-events-none after:absolute after:inset-[-4px] after:z-0 after:rounded-lg after:content-['']"),children:e.jsx(bs,{iconClassName:"icon-sm z-10",iconOnly:!0,onCopy:n})})},gt="module:",Ee=({log:s,isDisabled:t=!1,onClick:n})=>e.jsx("div",{className:"flex items-center",children:"line"in s&&s.line!=null&&e.jsxs("button",{onClick:()=>s.line!=null&&n?.(s.line),className:"text-token-text-tertiary select-none enabled:hover:underline",disabled:t,children:[gt,s.line]})}),ht=({isPreview:s=!1,log:t,level:n})=>e.jsxs("span",{className:E("text-token-text-primary flex min-w-0 flex-wrap gap-1",s?"shrink truncate":"whitespace-pre-wrap",n==="warn"&&"text-yellow-600"),children:[n==="warn"&&"[warn]: ",typeof t=="string"?t:t.map((a,r)=>e.jsx(ft,{isPreview:s,value:a},r))]}),ts=({error:s,isPreview:t=!1,isResolved:n=!1})=>{const a=s.name+":";return e.jsxs("span",{className:E("whitespace-pre-wrap",n?"text-token-text-primary":"text-red-500"),children:[e.jsx("span",{className:"font-semibold",children:a})," ",s.message,e.jsx("div",{children:s.stack.length>0&&!t?s.stack.join(`
`):""})]})},yt=({output:s,isPreview:t=!1})=>{const n=ne();return s==null?null:Xe(s)?e.jsx("img",{alt:n.formatMessage(Nt.imgAlt),className:E(t&&"border-token-border-xlight h-6 rounded-lg border"),src:s}):e.jsx("span",{className:"flex items-center gap-2",children:xe(s)})},ve=({log:s,isHintResolved:t,isPreview:n=!1})=>{switch(s.type){case j.LOG:return e.jsx(ht,{isPreview:n,...s});case j.ERROR:return e.jsx(ts,{isPreview:n,isResolved:t,...s});case j.OUTPUT:return e.jsx(yt,{isPreview:n,...s});default:return null}},jt=({log:s,isStale:t=!1,onClickFix:n,onClickLineNumber:a,hint:r})=>{const[l,c]=o.useState(!1);if(s.type===j.RUN_COMPLETE)return null;const m=r?.status===H.RESOLVED,d=s.type===j.ERROR&&r?.status===H.READY;return e.jsx(se,{hasHint:d,isHintOpen:l,bottomBorder:!0,onClick:r&&!m&&(()=>c(!0)),contentBefore:e.jsx(Ye,{hint:r,isOpen:l,onOpenChange:c,onClickFix:i=>s.type===j.ERROR&&r&&n?.(i,r.id,s.error)}),contentAfter:e.jsx(Ee,{log:s,isDisabled:t,onClick:a}),children:e.jsx(ve,{log:s,isHintResolved:m})})},Nt=Te({imgAlt:{id:"L6t7Yb",defaultMessage:"Plot"},ranCode:{id:"ffa9Nt",defaultMessage:"Ran code"},askForHelp:{id:"wMZco9",defaultMessage:"Ask ChatGPT for help"},askForFix:{id:"A9pxgT",defaultMessage:"Fix it for me"}}),bt=({timestamp:s,duration:t})=>{const[,n]=o.useState(0);o.useEffect(()=>{setInterval(()=>{n(l=>l+1)},5e3)},[]);const a=Date.now(),r=Math.round((a-s)/1e3);return e.jsx(Se,{label:e.jsx(I,{id:"bFO21A",defaultMessage:"Code ran {count, plural, =0 {instantly} one {in # second} other {in # seconds}}",values:{count:Math.floor(t/1e3)}}),children:e.jsx("span",{className:"text-token-text-tertiary",children:r>=60?e.jsx(rs,{value:-r,updateIntervalInSeconds:60,numeric:"auto"}):e.jsx(I,{id:"bRCEFN",defaultMessage:"Just now"})})})},ns=({isComplete:s,timestamp:t,duration:n})=>s&&t!=null&&n!=null?e.jsx(bt,{timestamp:t,duration:n}):s&&n==null?e.jsx("span",{className:"text-token-text-tertiary",children:e.jsx(I,{id:"EMebM9",defaultMessage:"Stopped"})}):e.jsx(Re,{gap:2}),wt=s=>{switch(s){case $.INITIALIZING:return e.jsx(I,{id:"J183Z0",defaultMessage:"initializing environment"});case $.INSTALLING_PACKAGES:return e.jsx(I,{id:"21sQ8o",defaultMessage:"installing packages"});case $.RUNNING_CODE:return e.jsx(I,{id:"nHITHk",defaultMessage:"running code"})}},de=({message:s,isComplete:t,statusLogs:n})=>{const a=je(n);return e.jsxs("span",{className:"flex items-center",children:[e.jsx("span",{className:"text-token-text-secondary font-semibold",children:e.jsx(I,{...s})}),!t&&a&&e.jsxs(T.span,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{delay:.3,duration:.1},className:"text-token-text-tertiary ms-2 flex items-baseline",children:[wt(a.status),e.jsx(Re,{gap:2,size:2})]})]})},Et=({children:s,firstLog:t,lastLog:n,isHintResolved:a,duration:r,isComplete:l=!1,isLast:c=!1,statusLogs:m})=>{const[d,i]=o.useState(!0),[u,g]=o.useState(!1),x=o.useRef(null),N=()=>{i(!d)};return o.useEffect(()=>{const{current:f}=x;if(!f)return;const v=new IntersectionObserver(O=>{O[0].intersectionRatio===0?g(!0):g(!1)},{threshold:0});return v.observe(f),()=>v.unobserve(f)},[]),e.jsxs("li",{className:"relative flex flex-col",children:[e.jsx("div",{"aria-hidden":"true",className:"pointer-events-none absolute h-[1px] bg-transparent",ref:x}),e.jsxs(se,{as:"div",disableEntryAnimation:!0,isSticky:!0,bottomBorder:u||!c&&!d,contentAfter:e.jsx(ns,{isComplete:l,duration:r,timestamp:t?.timestamp}),contentBefore:e.jsx("button",{className:"text-token-text-tertiary",onClick:()=>N(),children:e.jsx(Ss,{className:E("icon transition-transform",d&&"rotate-90")})}),onClick:()=>N(),children:[e.jsx(de,{isComplete:l,message:ue.run,statusLogs:m}),!d&&n&&e.jsx(ve,{isPreview:!0,isHintResolved:a,log:n})]}),d&&s]})},St=({runMessages:s,onClickFix:t,onClickLineNumber:n,hints:a,isStale:r,isLast:l,includeContentBefore:c=!1})=>{const[m,d]=o.useState(!1),i=s.filter(p=>p.type===j.ENVIRONMENT_STATUS),u=s.filter(Ge),g=je(s),x=g?.type===j.RUN_COMPLETE,N=x?g.duration:null,f=u[0];if(x){if(u.length===0)return e.jsx(se,{isHintOpen:m,bottomBorder:!0,contentBefore:c,contentAfter:e.jsx(ns,{isComplete:x,duration:N,timestamp:f?.timestamp}),children:e.jsx(de,{isComplete:x,message:ue.success,statusLogs:i})});if(u.length===1&&f?.type===j.ERROR){const p=a.get(f.id);return e.jsxs(se,{hasHint:!!p,isHintOpen:m,bottomBorder:!0,contentBefore:(c||!!p)&&e.jsx(Ye,{hint:p,isOpen:m,onOpenChange:d,onClickFix:S=>t?.(S,f.id,f.error)}),contentAfter:e.jsx(Ee,{log:f,isDisabled:r,onClick:n}),onClick:p&&p.status!==H.RESOLVED&&(()=>d(!0)),children:[e.jsx(de,{isComplete:x,message:ue.run,statusLogs:i}),e.jsx(ts,{isResolved:p?.status===H.RESOLVED,...f})]})}else if(u.length===1&&f&&!qe(u[0]))return e.jsxs(se,{bottomBorder:!0,contentBefore:c,contentAfter:e.jsx(Ee,{log:f,isDisabled:r,onClick:n}),children:[e.jsx(de,{isComplete:x,message:ue.run,statusLogs:i}),e.jsx(ve,{log:f})]})}const v=je(u.filter(p=>p.type!==j.RUN_COMPLETE)),w=(v&&a.get(v.id))?.status===H.RESOLVED;return e.jsx(Et,{statusLogs:i,firstLog:f??null,lastLog:v??null,duration:N,isComplete:x,isHintResolved:w,isLast:l,children:e.jsx("ol",{children:u.map(p=>e.jsx(jt,{log:p,isStale:r,onClickLineNumber:n,onClickFix:t,hint:a.get(p.id)},p.id))})})},ue=Te({success:{id:"laZI5H",defaultMessage:"Run successfully"},run:{id:"o7dgBT",defaultMessage:"Run"}}),Rt=`You're a professional developer highly skilled in debugging. The user ran the textdoc's code, and an error was thrown.
Please think carefully about how to fix the error`,vt=(s,t,n)=>{const a=He(s,n);return`
${Rt}, and then rewrite the textdoc to fix it.

- NEVER change existing test cases unless they're clearly wrong.
- ALWAYS add more test cases if there aren't any yet.
- ALWAYS ask the user what the expected behavior is in the chat if the code is not clear.

${t?`# Hint

${t}

`:""}
# Error

${a}`.trim()},kt=({codeRunMessages:s,scrollRef:t,onClose:n,onClickLineNumber:a,onClickFix:r,title:l,headerActions:c,lastRunId:m,hints:d})=>{const i=d.size>0,u=o.useMemo(()=>Object.entries(Cs(s,"runId")),[s]),g=u.some(([,x])=>{const N=x.filter(Ge);return N.length>1||N.length===1&&qe(N[0])});return e.jsxs(e.Fragment,{children:[e.jsx(dt,{title:l,actions:c,onClose:n,showBorder:s.length>0}),e.jsx("div",{ref:t,className:"bg-token-main-surface-primary flex flex-1 flex-col-reverse overflow-auto",children:e.jsx("ol",{className:"flex flex-1 flex-col justify-start pb-4",children:e.jsx(me,{children:u.map(([x,N],f)=>e.jsx(St,{runMessages:N,includeContentBefore:g||i,onClickFix:r,onClickLineNumber:a,hints:d,isStale:x!==m,isLast:f===u.length-1},x))})})})]})},Ct=({sandboxRef:s,textdocContent:t,textdocTitle:n,textdocId:a,isOpen:r,isTextdocAttachedPending:l,headerActions:c=[],highlightLine:m,createTextdocTurn:d,onOpenChange:i},u)=>{const[g,x]=o.useState(!1),[N,f]=o.useState(!1),[v,O]=o.useState([]),[w,p]=o.useState(0),[S,_]=o.useState(null),[F,A]=o.useState(null),[P,L]=o.useState(()=>new Map),[G,Y]=o.useState(320),V=o.useRef(null),q=ne();o.useEffect(()=>A(null),[t]);const B=v.filter(b=>[j.LOG,j.ERROR,j.OUTPUT].includes(b.type)).length;o.useEffect(()=>{r&&p(B)},[r]);const D=o.useMemo(()=>{for(let b=v.length-1;b>=0;b--){const h=v[b];if(h.runId!==F)return null;if(h.type===j.ERROR)return h}return null},[v,F]),Z=(b,h,y)=>{const k=P.get(h);if(k){const{id:R,content:U}=k;L(C=>{const M=new Map(C);return M.set(R,{id:R,content:U,status:H.RESOLVED}),M})}_(h),d({sourceEvent:b,action:Ys.EDIT,userMessageType:ks.CONSOLE,content:vt(t,k?.content??null,y)})},ae=async(b,h)=>{if(!l){L(y=>{const k=new Map(y);return k.set(b,{id:b,status:H.LOADING,content:""}),k});try{const y=await xt(a,t,h);L(k=>{const R=new Map(k);return R.set(b,{id:b,status:H.READY,content:y}),R})}catch{L(k=>{const R=new Map(k);return R.delete(b),R})}}},he=async(b,h)=>{const y=Ws(b,h),k=$s(b,h),R=Hs(b);if(!y||!R&&!k)return;R&&i?.(!0),f(!0),O(M=>M.map(X=>({...X,isStale:!0})));let U=!1;const C=Us(s.current).evalAsync({code:h,language:y});for await(const M of C){if(M.type===j.RUN_START&&requestAnimationFrame(()=>{V.current?.scrollTo({top:0,behavior:"smooth"})}),M.type===j.ERROR){if(M.line!=null){const{line:X}=M;requestAnimationFrame(()=>m(X))}U=!0,ae(M.id,M)}A(M.runId),O(X=>[...X,{...M,isStale:!1}])}U&&i?.(!0),f(!1)};o.useImperativeHandle(u,()=>({runCode:he,stopCode:()=>s.current?.stop()}));const re=!r&&N,oe=re&&D&&D.id!==S,ie=!oe&&re&&B>w;return e.jsxs(me,{children:[g&&e.jsx("div",{className:"pointer-events-auto absolute inset-0 bg-transparent"},"drag-overlay"),ie&&e.jsx(T.button,{initial:{scale:.95,opacity:0},exit:{scale:.95,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",bounce:.12,duration:.3},className:"bg-token-main-surface-primary hover:bg-token-main-surface-secondary absolute end-2 bottom-2 flex items-center gap-2 rounded-full px-3 py-1.5 shadow-lg",onClick:()=>i?.(!0),children:e.jsxs("span",{className:"text-token-text-secondary flex items-center gap-1 text-sm",children:[e.jsx(Rs,{className:"icon-sm"}),e.jsx(I,{id:"etzFTa",defaultMessage:"{numLogs, plural, one {{numLogs} message} other {{numLogs} messages}}",values:{numLogs:B}})]})},"view-console"),oe&&e.jsx(mt,{textdocTitle:n,onClickViewConsole:()=>i?.(!0),onDismiss:()=>_(D.id),onClickFix:b=>{Z(b,D.id,D.error)}},"error-modal"),r&&e.jsxs(T.div,{initial:{translateY:"100%",opacity:0},animate:{translateY:"0%",opacity:1},exit:{translateY:"100%",opacity:0},transition:{type:"spring",bounce:0,duration:.48},className:"border-token-border-default relative z-10 w-full border-t shadow-[0px_0px_32px_rgba(0,0,0,0.08)]",children:[e.jsx(ut,{onDragEnd:()=>x(!1),onDrag:({delta:{y:b}})=>{x(!0),Y(h=>h-b)}}),e.jsx("div",{className:"flex flex-col",style:{height:G},children:e.jsx(kt,{scrollRef:V,codeRunMessages:v,onClose:()=>i?.(!1),onClickLineNumber:m,onClickFix:Z,title:q.formatMessage({id:"P9VJDk",defaultMessage:"Console"}),headerActions:[...c,{tooltip:q.formatMessage({id:"gAICYK",defaultMessage:"Clear console"}),icon:vs,onClick:()=>{p(0),O([]),L(new Map)}}],lastRunId:F,hints:P})})]},"console")]})},Dt=o.forwardRef(Ct);export{_t as C,Dt as a};
//# sourceMappingURL=m27qwee0va0l7e3n.js.map
