import{j as e,r as n,i as O,f as Q,a6 as W,a as Y,M as z}from"./b8ijctzpgh0s7wpx.js";import{jJ as K,ft as V,dY as w,ij as G,cC as v,bY as X,aA as Z,ad as $,d4 as ee,d5 as I,cB as E,jK as te,cs as se,jL as D}from"./krbmwir12ubt4od1.js";import{J,a as ae,S as ne,c as N,d as oe}from"./daid7veon13s2bqn.js";import{J as ie,S as re}from"./hyoix286427rgsrp.js";import{ad as F,s as ue,N as ce,c as q,j as le,ae as me,gL as B,cr as H,aU as de,ch as fe,ak as ge}from"./citrwydz0bgriwlc.js";import{u as he}from"./hwx0m0azjs4pnvcb.js";import{g as xe,a as pe}from"./kcrhrkba74367sn7.js";function be(){return"/tasks"}function je(){return e.jsx(L,{children:e.jsxs("div",{className:"flex h-full w-full flex-col justify-center py-4 ps-5 pe-3",children:[e.jsx("div",{className:"loading-results-shimmer bg-token-text-tertiary h-4 w-1/2 rounded-sm"}),e.jsx("div",{className:"loading-results-shimmer bg-token-text-tertiary mt-2.5 h-4 w-2/5 rounded-sm"})]})})}function L({children:t}){return e.jsx("div",{className:"border-token-border-default relative my-2 inline-block max-w-[360px] min-w-[320px] overflow-hidden rounded-xl border",children:t})}function we({automation:t}){return t?e.jsx(Ne,{item:t}):null}function Ne({item:t}){const s=F();n.useEffect(()=>{ue.count(ce.JAWBONE,"jawbone_message_attachment.open")},[]);const{id:o,is_enabled:i,title:d}=t,[h,a]=n.useState(!1),c=n.useRef(null);n.useEffect(()=>{if(c.current){const u=c.current.clientHeight,x=parseFloat(getComputedStyle(c.current).lineHeight);a(u>x)}},[d]);const f=t.next_run_times.length===0,[l,r]=n.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(L,{children:[e.jsx("button",{className:"hover:bg-token-main-surface-secondary h-full w-full",onClick:()=>r(!0),children:e.jsx("div",{className:q("flex h-full w-full cursor-pointer justify-between py-4 ps-5 pe-3",h?"items-start":"items-center"),children:e.jsxs("div",{className:"flex flex-col gap-0.5 pe-8 text-sm",children:[e.jsx("div",{ref:c,className:"line-clamp-2 text-start font-medium",children:d}),e.jsx("div",{className:"text-token-text-secondary text-start",children:e.jsx(J,{initialScheduleComponents:t.schedule_components,nextRunTimes:t.next_run_times,children:e.jsx(ie,{item:t})})})]})})}),e.jsx("div",{className:"absolute end-3 top-1/2 -translate-y-1/2 transform",children:e.jsx("div",{className:"ms-4 flex",children:e.jsx(ve,{automation_id:o,is_enabled:i,item:t,isFinished:f,onEditModalOpen:()=>r(!0)})})})]}),l&&e.jsx(J,{initialScheduleComponents:t.schedule_components,nextRunTimes:t.next_run_times,children:e.jsx(ae,{item:t,source:"chat",onClose:u=>{u&&s.success(u,{hasCloseButton:!0}),r(!1)}})})]})}function ve({automation_id:t,is_enabled:s,item:o,isFinished:i,onEditModalOpen:d}){const h=le(),a=O(),c=Q(),f=F(),[l,r]=n.useState(s);n.useEffect(()=>r(s),[s]);const{mutate:u,isPending:x}=K({automation_id:t,onError:m=>{f.danger(a.formatMessage(m?N.messages.enableFailure:N.messages.pauseFailure),{hasCloseButton:!0}),r(!m)}});return e.jsxs(V,{size:"auto",alignOffset:-8,sideOffset:4,triggerButton:e.jsx("button",{className:"hover:bg-token-surface-hover focus-visible:bg-token-surface-hover radix-state-open:bg-token-surface-hover flex h-9 w-9 items-center justify-center rounded-lg focus-visible:outline-0",children:e.jsx($,{className:"icon"})}),children:[!i&&e.jsxs(e.Fragment,{children:[e.jsx(w.Item,{icon:G,label:a.formatMessage(v.attachmentEdit),onClick:d}),e.jsx(w.Item,{icon:l?ne:re,label:a.formatMessage(l?N.messages.pause:N.messages.resume),onClick:()=>{const m=!l;r(m),u({is_enabled:m})},disabled:x})]}),e.jsx(w.Item,{icon:X,color:"danger",label:a.formatMessage(N.messages.delete),onClick:()=>{me(h,oe,{item:o})}}),e.jsx(w.Separator,{}),e.jsx(w.Item,{icon:Z,label:a.formatMessage(v.attachmentViewAll),onClick:()=>{c(be())}})]})}function Me({highlightedText:t,shouldShimmer:s,className:o}){return e.jsx(W,{children:e.jsx("div",{className:q(s&&"loading-shimmer-pure-text","absolute start-0 top-0 flex h-8 gap-1 overflow-hidden",o),children:e.jsx("span",{children:t})})})}const P="Too many active automations";function Pe({clientThreadId:t,currentGroupedMessage:s,nextMessage:o,isLastMessage:i,isRequestActive:d}){const h=i||o,a=d&&!o,c=n.useRef(a);n.useEffect(()=>{a&&(c.current=a)},[a]);const f=s,l=n.useMemo(()=>{for(const g of f?.messages||[]){const b=B(g.author.name);if(b?.namespace===H.DE1D73E)return b}},[f]),r=Se(f,a),u=r?.automationId??"",x=r?.updatedAt??"0",m=r?.error,[M,U]=n.useState(!0),{automation:p,error:j}=he(u);n.useEffect(()=>{j&&j instanceof de&&(j.status===404||j.status===410)&&U(!1)},[j]);const y=Y();n.useEffect(()=>{if(!M)return;const g=new Date(x),b=new Date(p?.updated_at);!isNaN(g.getTime())&&!isNaN(b.getTime())&&b<g&&y.invalidateQueries({queryKey:ee.getAutomationQueryKey(u)})},[p,u,x,M,y]);const S=f.messages,A=S[S.length-1]?.metadata?.permissions,C=n.useMemo(()=>A?.some(g=>g.type==="notification"&&g.status==="requested"),[A]);n.useEffect(()=>(m===P&&c.current&&I.setMaxBannerClientThreadId(t),()=>{I.clearMaxBannerClientThreadId()}),[m,t]),n.useEffect(()=>{E.initIfNeeded()},[]);const k=S[0].create_time,T=n.useRef(!1),R=Ae();if(n.useEffect(()=>{(async()=>{if(!R){E.clearNotificationRequest();return}if(T.current)return;await ye(p,C,k)&&(T.current=!0,E.setRequestingClientThreadId(t))})()},[p,k,t,C,R]),!a&&m&&m!==P)return e.jsx(Ee,{errorUserMessage:r?.errorUserMessage});if(M&&h){if(u)return p?e.jsx(we,{automation:p}):a?e.jsx(_,{functionName:l?.functionName}):e.jsx(je,{});if(a&&l)return e.jsx(_,{functionName:l.functionName})}return null}function _({functionName:t}){const s=O();return e.jsx("div",{className:"text-token-text-secondary relative my-2 h-8 first:mt-0",children:e.jsx(Me,{highlightedText:s.formatMessage(t==="update"?v.updatingAutomation:v.makingAutomation),className:"me-1.5 mt-1 items-center justify-start",shouldShimmer:!0})})}function Se(t,s){return n.useMemo(()=>{if(s)return;const o=t?.messages?.find(i=>B(i.author.name)?.namespace===H.DE1D73E);if(o)try{const i=JSON.parse(fe(o));return i.status==="ERROR"?{error:i.message,errorUserMessage:i.user_message}:{automationId:i.jawbone.id,updatedAt:i.jawbone.updated_at}}catch(i){ge.addError("Jawbone: Failed to parse automation message",{cause:i});return}},[t,s])}function Ee({errorUserMessage:t}){return e.jsxs("div",{className:"text-token-text-error flex items-center gap-2 pb-1",children:[e.jsx(se,{className:"icon-sidebar"}),e.jsx("div",{children:t??e.jsx(z,{id:"oOQhkY",defaultMessage:"Task scheduling wasn’t completed — please ask again."})})]})}async function ye(t,s,o){if(!t||!s||!o)return!1;const i=new Date(o*1e3);if(!(Math.abs(new Date().getTime()-i.getTime())<=5*60*1e3))return!1;const a=D.getLastRequestTime();return!(a&&Date.now()-new Date(a).getTime()<24*60*60*1e3||D.getPermission()==="denied"||!await xe()||await pe())}function Ae(){const{data:t}=te({alwaysRefetchOnMount:!1});return t?.some(s=>s.category==="tasks"&&s.options.some(o=>o.channel==="push"&&o.enabled))}export{Pe as JawboneMessage};
//# sourceMappingURL=mnja07nl06pmo8dv.js.map
