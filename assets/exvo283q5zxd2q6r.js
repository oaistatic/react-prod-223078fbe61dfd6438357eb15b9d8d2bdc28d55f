import{r as h,p as z,j as B}from"./b8ijctzpgh0s7wpx.js";import{aM as n,m as x,g7 as G,bL as I,d4 as V,e as T,eH as C,j as U,dT as N,k as R,b1 as Y,cc as Q,c7 as E,n as _}from"./citrwydz0bgriwlc.js";import{da as Z,eb as $,dZ as K,ec as J,ed as X,ee as q,ef as ee,eg as te,V as se,eh as re,ei as ie,ej as ne,ek as ae}from"./krbmwir12ubt4od1.js";import{a as oe}from"./jekpe1ukp5thtucq.js";function ue(a,e){const{availableConnectors:s}=oe(),r=Z(a),t=x(a,p=>p?.mode),i=G(),o=$(e??[]),S=h.useMemo(()=>(i.isSuccess&&i.data?i.data:void 0)?.filter(m=>m.systemHint===n.Slurm?s.length>0:!0)?.filter(m=>m.requiresOptIn?o.includes(m.systemHint):!0)??[],[i.data,i.isSuccess,o,s.length]),u=K({clientThreadId:a}),{userIsInSearchHoldoutWithWebDisabled:g}=J(),f=I(),M=h.useMemo(()=>de({modelConfig:r,userIsInSearchHoldoutWithWebDisabled:g,isTemporaryChatEnabled:f,conversationMode:t,systemHints:S,modelSwitcherDenials:u}),[S,r,u,t,g,f]);return{systemHints:S,activeSystemHints:M,isLoading:i.isLoading}}function de({modelConfig:a,userIsInSearchHoldoutWithWebDisabled:e,isTemporaryChatEnabled:s,conversationMode:r,systemHints:t,modelSwitcherDenials:i}){return le({modelConfig:a,systemHints:t,isTemporaryChatEnabled:s}).filter(o=>!(o.systemHint===n.Search&&e||!(o.requiredModels.length===0||o.requiredModels.some(u=>!i[u]))||!A(o,r)))}function A(a,e){return a.requiredConversationModes.length===0||a.requiredConversationModes.some(s=>s===e?.kind)}function le({modelConfig:a,systemHints:e,isTemporaryChatEnabled:s}){const r=new Set(a?.enabledTools||[]);return e.filter(t=>!(a?.enabledTools===void 0||t.requiredFeatures.length===0||t.requiredFeatures.every(o=>r.has(o)))||!t.allowInTemporaryChat&&s?!1:[n.ContextualAnswers,n.Slurm].includes(t.systemHint)&&a?t.requiredModels?.includes(a.id):!0)}class y extends V()(({initialHints:e,availableHints:s,locked:r=!1})=>({locked:r,persistedSystemHints:new Set(e),persistedSystemHintTriggers:{},availableHints:s,recentHints:X})){static getPersistedSystemHints=({persistedSystemHints:e})=>e;static getAvailableSystemHints=({availableHints:e})=>e;addPersistedSystemHint=(e,s,r)=>{this.getState().locked||(e===n.Search&&T.logEventWithStatsig("Search Mode Engaged","search_mode_engaged",{...C(s),triggerSource:r}),this.setState(({persistedSystemHints:t,persistedSystemHintTriggers:i})=>({persistedSystemHints:new Set(t).add(e),persistedSystemHintTriggers:{...i,[e]:r}})))};removePersistedSystemHint=(e,s)=>{this.getState().locked||(e===n.Search&&T.logEventWithStatsig("Search Mode Disabled","search_mode_disabled",C(s)),this.setState(({persistedSystemHints:r,persistedSystemHintTriggers:t})=>{const i=new Set(r);i.delete(e);const o={...t};return delete o[e],{persistedSystemHints:i,persistedSystemHintTriggers:o}}))};getPersistedSystemHintTrigger=e=>{if(!this.getState().locked&&this.getState().persistedSystemHints.has(e))return this.getState().persistedSystemHintTriggers[e]};clearPersistedSystemHintTrigger=e=>{this.getState().locked||this.setState(({persistedSystemHints:s,persistedSystemHintTriggers:r})=>{const t={...r};delete t[e];const i=new Set(s);return i.delete(e),{persistedSystemHints:i,persistedSystemHintTriggers:t}})};clearAllPersistedSystemHintTriggers=({skip:e}={})=>{this.getState().locked||e&&e.some(s=>this.getState().persistedSystemHints.has(s))||this.setState(()=>({persistedSystemHints:new Set,persistedSystemHintTriggers:{}}))};updatePersistedSystemHint=(e,s,r)=>{this.getState().locked||(e===n.Search&&T.logEventWithStatsig("Search Mode Engaged","search_mode_engaged",{...C(s),triggerSource:r}),this.setState(({recentHints:t})=>({persistedSystemHints:new Set(e?[e]:[]),persistedSystemHintTriggers:e?{[e]:r}:{},...e&&!(t.includes(e)||e===n.PictureV2&&t.includes(n.Picture)||e===n.Picture&&t.includes(n.PictureV2))&&{recentHints:[e,...t.slice(1)]}})))}}const He=()=>y.useState(y.getPersistedSystemHints);function ce({persistSearchMode:a,persistTatertotMode:e,forcedSystemHintType:s,completionMetadataHints:r}){if(s)return[s];const t=[];return a&&t.push(n.Search),e&&t.push(n.Tatertot),r&&t.push(...r),t}function ye({children:a,clientThreadId:e,forcedSystemHintType:s,optInTypes:r}){const t=U(),[i]=z(),o=i.get(q)===n.Search,S=i.get(q)==="student",{systemHints:u}=ue(e,r),g=ee(),f=te(e),M=x(e,d=>_.getGizmoId(d)),p=se(M),m=re(e),D=ie(m,N.Search),H=x(e,_.getLastMessageSystemHints),w=R(t,"269676899",{disableExposureLog:!0}),L=w.get("clear_all",!1),F=w.get("skip_search",!1),O=L&&!F,P=(H.includes(n.Search)||o)&&D&&!O,v=Y(t,"3240576626")&&(H.includes(n.Tatertot)||S),b=h.useMemo(()=>H.filter(d=>u.find(c=>c.systemHint==d)?.persistBetweenMessages),[H,u]),W=Q(()=>ae(t)()[e]),j=ce({persistSearchMode:P,persistTatertotMode:v,forcedSystemHintType:s,completionMetadataHints:W}),[l]=h.useState(()=>new y({initialHints:j,availableHints:Object.values(g),locked:s!=null}));return h.useEffect(()=>{const d=l.getState().persistedSystemHints;P&&!d.has(n.Search)?l?.addPersistedSystemHint(n.Search,{clientThreadId:e,turnIndex:0}):v&&!d.has(n.Tatertot)?l?.addPersistedSystemHint(n.Tatertot,{clientThreadId:e,turnIndex:0}):b.length&&b.map(c=>l?.addPersistedSystemHint(c,{clientThreadId:e,turnIndex:0}))},[P,v,l,e,b]),h.useEffect(()=>{if(u==null||u.length===0)return;const d=s!=null?u.find(c=>c.systemHint===s):void 0;if(s!=null&&d!=null)l.setState({availableHints:[d]});else{const c=u.filter(k=>k.systemHint!==n.Think&&!k.composerBarButtonInfo?.upsell);l.setState({availableHints:ge(Se(g,c),f,p)})}},[u,l,g,f,p,s,e]),B.jsx(y.Provider,{store:l,children:a})}const Se=(a,e)=>{const s=e.filter(r=>!a[r.systemHint]&&r.systemHint!==n.Picture);return[...Object.keys(a).map(r=>e.find(i=>i.systemHint===r||i.systemHint===n.Picture&&r===n.PictureV2)??a[r]),...s]},ge=(a,e,s)=>{const r=e?ne(e):void 0;if(!r)return a;const t=r?.tools.map(i=>i.type);return a.filter(i=>{if(!A(i,e))return!1;if(s)return!0;switch(i.systemHint){case n.Search:return t.includes(E.BROWSER);case n.Canvas:return t.includes(E.CANVAS);case n.Picture:case n.PictureV2:return t.includes(E.DALLE);default:return!0}})};export{ye as P,y as a,ue as b,le as g,He as u};
//# sourceMappingURL=exvo283q5zxd2q6r.js.map
